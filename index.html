<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>FinanzaPro Budget</title>

    <!-- PWA Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SpesePro">
    <link rel="apple-touch-icon" href="https://i.ibb.co/vx96Xb8Q/budget.png">

    <!-- Manifest Base64 -->
    <link rel="manifest" href="data:application/json;base64,ewogICJkZWZhdWx0X2xvY2FsZSI6ICJpdCIsCiAgIm5hbWUiOiAiR2VzdGlvbmUgU3Blc2UgUHJvIiwKICAic2hvcnRfbmFtZSI6ICJTcGVzZVBybyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pLmliYi5jby92eDk2WGI4US9idWRnZXQucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXSwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjNmNGY2IiwKICAidGhlbWVfY29sb3IiOiAiIzI1NjNmMSIKfQ==">

    <meta name="theme-color" content="#4f46e5">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], heading: ['Poppins', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f5f3ff', 100: '#ede9fe', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9', 800: '#5b21b6', 900: '#4c1d95' }
                    },
                    boxShadow: { 'soft': '0 10px 40px -10px rgba(0,0,0,0.08)' }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, .font-heading {
            font-family: 'Poppins', sans-serif;
        }

        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-transition {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px #ddd6fe; /* Questo crea l'effetto "ring" corretto */
        }

        .transaction-card:active {
            transform: scale(0.98);
            background-color: #f5f3ff;
        }

        header {
            padding-top: env(safe-area-inset-top, 2.5rem);
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 1rem);
        }

        .toast {
            position: fixed;
            bottom: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="antialiased text-gray-900">

    <div id="toast" class="toast">Messaggio</div>

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-lg relative">

        <!-- View Principale -->
        <div id="main-view">
            <header class="bg-gradient-to-br from-brand-800 via-brand-700 to-brand-600 text-white pb-8 rounded-b-[2.5rem] shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-20 -mt-20 pointer-events-none"></div>

                <div class="relative px-6 pt-4">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="toggleSettings(true)" class="p-2 bg-white/10 backdrop-blur-md rounded-xl hover:bg-white/20 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-100" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                        <div class="flex flex-col items-center">
                            <span id="account-name-display" class="text-xs font-bold uppercase tracking-widest text-brand-200">Conto</span>
                            <div class="flex items-center space-x-1 mt-0.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-400"></span>
                                <span class="text-[10px] text-brand-100">Attivo</span>
                            </div>
                        </div>
                        <div class="relative">
                            <button onclick="triggerCamera()" class="p-2 bg-white text-brand-600 rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                            <div id="camera-loader" class="absolute inset-0 bg-white rounded-xl flex items-center justify-center hidden"><div class="loader" style="width:14px; height:14px; border-width:2px;"></div></div>
                        </div>
                    </div>

                    <div class="text-center mt-2 mb-6">
                        <div class="flex items-center justify-center space-x-6 mb-2">
                            <button onclick="changeMonth(-1)" class="p-1 text-brand-200 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                            <h2 id="current-month-display" class="text-lg font-heading font-medium text-brand-100 min-w-[120px]">Mese</h2>
                            <button onclick="changeMonth(1)" class="p-1 text-brand-200 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                        </div>
                        <div id="balance" class="text-5xl font-heading font-bold tracking-tight drop-shadow-sm">â‚¬ 0.00</div>
                        <div id="initial-balance-display" class="text-xs mt-2 text-brand-200 bg-brand-900/30 inline-block px-3 py-1 rounded-full hidden"></div>
                    </div>

                    <div id="budget-container" class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/10 hidden">
                        <div class="flex justify-between text-xs text-brand-100 mb-2 font-medium">
                            <span>Speso: <strong id="budget-spent" class="text-white">â‚¬0</strong></span>
                            <span>Budget: <strong id="budget-total" class="text-white">â‚¬0</strong></span>
                        </div>
                        <div class="w-full bg-brand-900/40 rounded-full h-2 overflow-hidden">
                            <div id="budget-bar" class="bg-white h-full rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="flex justify-center mt-6 space-x-2">
                        <button onclick="navigateAccount(-1)" class="w-2 h-2 rounded-full bg-white/30 hover:bg-white"></button>
                        <button onclick="navigateAccount(1)" class="w-2 h-2 rounded-full bg-white/30 hover:bg-white"></button>
                    </div>
                </div>
            </header>

            <main class="flex-grow p-4">
                <div class="grid grid-cols-2 gap-4 -mt-6 mb-8 px-2 relative z-10">
                    <button onclick="openModal('income')" class="bg-white p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center space-y-2 active:scale-95 transition-all border border-green-50">
                        <div class="p-3 bg-green-100 text-green-600 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" /></svg>
                        </div>
                        <span class="font-bold text-gray-600 text-sm">Entrata</span>
                    </button>
                    <button onclick="openModal('expense')" class="bg-white p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center space-y-2 active:scale-95 transition-all border border-red-50">
                        <div class="p-3 bg-red-100 text-red-500 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6" /></svg>
                        </div>
                        <span class="font-bold text-gray-600 text-sm">Uscita</span>
                    </button>
                </div>

                <div id="chart-container" class="mb-8 bg-gray-50 p-4 rounded-2xl hidden">
                    <canvas id="expenseChart" width="200" height="200"></canvas>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 italic">Movimenti</h2>
                </div>

                <div id="transaction-list" class="space-y-3 pb-24"></div>
            </main>
        </div>

        <!-- View Impostazioni -->
        <div id="settings-view" class="hidden absolute inset-0 bg-gray-50 z-40 overflow-y-auto pb-10">
            <header class="bg-white p-6 border-b sticky top-0 flex items-center justify-between z-10">
                <button onclick="toggleSettings(false)" class="p-2 text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7 7-7" /></svg>
                </button>
                <h2 class="text-lg font-bold">Impostazioni</h2>
                <div class="w-10"></div>
            </header>

            <div class="p-6 space-y-6">
                <!-- Sezione Conti -->
                <div class="settings-card">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">I Tuoi Conti & Budget</h3>
                    <div id="account-list-settings" class="space-y-2 mb-4"></div>

                    <div class="bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                        <div class="text-[10px] font-bold text-gray-400 uppercase mb-2">Aggiungi nuovo conto</div>
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <input type="text" id="new-account-name" placeholder="Nome (es. Hype)"
                                       class="flex-1 min-w-0 p-2 bg-white rounded-lg text-sm border outline-none shadow-sm">

                                <input type="number" id="new-account-budget" placeholder="Budget â‚¬"
                                       class="w-20 p-2 bg-white rounded-lg text-sm border outline-none shadow-sm text-center">
                            </div>
                            <button onclick="addAccount()"
                                    class="w-full py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold active:bg-indigo-700 transition-colors">
                                Aggiungi Conto
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sezione Backup Avanzato -->
                <div class="settings-card">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Salvataggio & Cloud</h3>
                    <p class="text-[11px] text-gray-500 mb-4 leading-tight">Puoi salvare il backup su Google Drive, iCloud o nel tuo File System per non perdere mai i dati.</p>

                    <div class="space-y-3">
                        <button onclick="shareBackup()" class="w-full flex items-center justify-between p-4 bg-indigo-600 text-white rounded-xl shadow-sm active:bg-indigo-700 transition-colors">
                            <div class="flex items-center space-x-3 text-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-3.316 3 3 0 000 3.316m0 0a3 3 0 100 3.316 3 3 0 000-3.316" /></svg>
                                <div>
                                    <div class="font-bold text-sm">Invia a Cloud / Drive</div>
                                    <div class="text-[10px] opacity-80 uppercase font-medium">Usa menu di sistema</div>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>

                        <button onclick="saveToFileSystem()" class="w-full flex items-center justify-between p-4 bg-white border border-gray-200 text-gray-700 rounded-xl shadow-sm active:bg-gray-50 transition-colors">
                            <div class="flex items-center space-x-3 text-left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1m-6 9l3-3m0 0l3 3m-3-3V10" /></svg>
                                <div>
                                    <div class="font-bold text-sm text-gray-800">Salva in locale</div>
                                    <div class="text-[10px] text-gray-400 uppercase font-medium">Scegli cartella o Drive</div>
                                </div>
                            </div>
                        </button>

                        <div class="grid grid-cols-2 gap-3">
                            <label class="flex flex-col items-center justify-center p-3 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-indigo-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                <span class="text-[10px] font-bold text-gray-500 mt-1 uppercase">Importa</span>
                                <input type="file" id="import-json" class="hidden" accept=".json" onchange="importJSON(event)">
                            </label>

                            <button onclick="exportCSV()" class="flex flex-col items-center justify-center p-3 bg-green-50 border border-green-200 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                <span class="text-[10px] font-bold text-green-700 mt-1 uppercase">Export CSV</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">AI Engine</h3>
                    <button onclick="promptApiKey()" class="w-full py-2 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold">Aggiorna API Key Gemini</button>
                </div>

                <div class="settings-card border-red-100 bg-red-50">
                    <button onclick="clearHistory()" class="w-full p-2 text-red-600 text-[10px] font-bold uppercase tracking-widest">
                        Resetta tutti i dati
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Inserimento -->
        <div id="modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

            <div id="modal-content" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2rem] shadow-2xl transform translate-y-full transition-transform duration-300 flex flex-col max-h-[90vh]">

                <div class="w-full flex justify-center pt-4 pb-2" onclick="closeModal()">
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full"></div>
                </div>

                <div class="px-6 pb-6 overflow-y-auto no-scrollbar">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="modal-title" class="text-lg font-heading font-semibold text-gray-500 uppercase tracking-wider">Nuova Transazione</h3>
                        <button onclick="closeModal()" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    <div class="mb-8 relative text-center">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Importo</label>
                        <div class="relative flex items-center justify-center">
                            <input type="number" id="amount-input" step="0.01" inputmode="decimal" placeholder="0.00" class="w-full text-5xl font-heading font-bold text-gray-800 text-center bg-transparent border-none focus:ring-0 p-0 placeholder-gray-200">
                            <button onclick="triggerCamera()" class="absolute right-0 top-1/2 -translate-y-1/2 p-3 text-brand-500 bg-brand-50 rounded-2xl active:scale-95 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-2xl p-3 border border-gray-100">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Data</label>
                                <input type="date" id="date-input" class="w-full bg-transparent font-semibold text-gray-700 text-sm outline-none">
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-3 border border-gray-100">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Conto</label>
                                <select id="modal-account-select" class="w-full bg-transparent font-semibold text-gray-700 text-sm outline-none appearance-none"></select>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 flex items-center">
                            <span class="text-gray-400 mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </span>
                            <input type="text" id="desc-input" placeholder="Aggiungi nota..." class="w-full bg-transparent font-medium text-gray-700 placeholder-gray-400 outline-none">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-3 ml-1">Categoria</label>
                            <div id="category-grid" class="grid grid-cols-4 gap-3">
                            </div>
                        </div>

                        <div class="pt-4 flex gap-3 pb-safe">
                            <button id="delete-btn" onclick="deleteTx(editingTxId)" class="hidden w-16 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center active:bg-red-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <button onclick="saveTransaction()" id="save-btn" class="flex-1 py-4 rounded-2xl text-white font-heading font-semibold text-lg shadow-lg active:scale-95 transition-all">
                                Salva Movimento
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_TX = 'spese_v3_data';
        const STORAGE_ACC = 'spese_v3_accounts';
        let apiKey = localStorage.getItem('gemini_api_key') || "";

        const categories = {
            expense: [
                { id: 'cibo', label: 'Cibo', icon: 'ðŸŽ', color: '#f87171' },     // Rosso soft
                { id: 'casa', label: 'Casa', icon: 'ðŸ ', color: '#60a5fa' },     // Blu soft
                { id: 'trasporti', label: 'Auto', icon: 'ðŸš—', color: '#fbbf24' }, // Giallo
                { id: 'svago', label: 'Svago', icon: 'ðŸŽ®', color: '#a78bfa' },    // Viola
                { id: 'salute', label: 'Salute', icon: 'ðŸ’Š', color: '#34d399' },  // Verde
                { id: 'shopping', label: 'Shopping', icon: 'ðŸ›ï¸', color: '#f472b6' }, // Rosa
                { id: 'altro', label: 'Altro', icon: 'ðŸ“¦', color: '#94a3b8' }     // Grigio
            ],
            income: [
                { id: 'stipendio', label: 'Stipendio', icon: 'ðŸ’°', color: '#10b981' },
                { id: 'regalo', label: 'Regalo', icon: 'ðŸŽ', color: '#f59e0b' },
                { id: 'altro_in', label: 'Altro', icon: 'ðŸ“ˆ', color: '#6b7280' }
            ]
        };

        let transactions = JSON.parse(localStorage.getItem(STORAGE_TX)) || [];
        // Accounts migration: ensure existing accounts have budget set to 0 if not present
        let rawAccounts = JSON.parse(localStorage.getItem(STORAGE_ACC)) || [{ id: 'acc_01', name: 'Conto Corrente', budget: 0 }];
        let accounts = rawAccounts.map(a => ({
            ...a,
            budget: a.budget || 0,
            initialBalance: a.initialBalance || 0
        }));

        let activeAccountId = accounts[0].id;
        let viewDate = new Date();
        let currentMode = 'expense';
        let selectedCategory = 'altro';
        let editingTxId = null;
        let chartInstance = null;

        let numberCallback = null;

        function openNumberModal(title, value, callback) {
            document.getElementById('numberTitle').innerText = title;

            const input = document.getElementById('numberInput');
            input.value = value ?? '';

            numberCallback = callback;
            document.getElementById('numberModal').classList.remove('hidden');

            setTimeout(() => input.focus(), 50);
        }

        function closeNumberModal() {
            document.getElementById('numberModal').classList.add('hidden');
            numberCallback = null;
        }

        function confirmNumberModal() {
            if (!numberCallback) return;

            const raw = document.getElementById('numberInput').value.replace(',', '.');
            const val = parseFloat(raw);

            if (isNaN(val)) {
                alert("Inserisci un numero valido");
                return;
            }

            numberCallback(val);
            closeNumberModal();
        }

        // UI TOAST
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        // BACKUP AVANZATO
        async function shareBackup() {
            const data = { app: "SpesePro", version: "3.1", transactions, accounts };
            const json = JSON.stringify(data, null, 2);
            const filename = `backup_spesepro_${new Date().toISOString().split('T')[0]}.json`;

            if (navigator.share) {
                const file = new File([json], filename, { type: 'application/json' });
                try {
                    await navigator.share({
                        title: 'Backup SpesePro',
                        text: 'File di backup della mia app di gestione spese.',
                        files: [file]
                    });
                    showToast("Menu condivisione aperto!");
                } catch (err) {
                    if (err.name !== 'AbortError') showToast("Errore condivisione");
                    downloadBackupManual(json, filename);
                }
            } else {
                downloadBackupManual(json, filename);
            }
        }

        async function saveToFileSystem() {
            const data = { app: "SpesePro", transactions, accounts };
            const json = JSON.stringify(data, null, 2);
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: `backup_spese_${new Date().toISOString().split('T')[0]}.json`,
                        types: [{ description: 'JSON File', accept: { 'application/json': ['.json'] } }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(json);
                    await writable.close();
                    showToast("Salvato con successo!");
                } catch (err) {
                    if (err.name !== 'AbortError') showToast("Impossibile salvare");
                }
            } else {
                downloadBackupManual(json, `backup_spese_${new Date().toISOString().split('T')[0]}.json`);
            }
        }

        function downloadBackupManual(json, filename) {
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showToast("Backup scaricato!");
        }

        // LOGICA CONTI E BUDGET
        function addAccount() {
            const nameInput = document.getElementById('new-account-name');
            const budgetInput = document.getElementById('new-account-budget');
            const name = nameInput.value.trim();
            const budget = parseFloat(budgetInput.value) || 0;
            const initialBalance = parseFloat(prompt("Saldo iniziale del conto (â‚¬):", "0")) || 0;

            if (!name) return;
            accounts.push({ id: 'acc_' + Date.now(), name, budget, initialBalance });
            localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
            nameInput.value = '';
            budgetInput.value = '';
            renderSettingsAccounts();
            updateUI();
        }

        function renameAccount(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            const newName = prompt("Rinomina conto:", acc.name);
            if (newName) {
                acc.name = newName;
                localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
                renderSettingsAccounts();
                updateUI();
            }
        }

        function setBudget(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            openNumberModal("Budget mensile (â‚¬)", acc.budget || 0, val => {
                acc.budget = val;
                localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
                renderSettingsAccounts();
                updateUI();
            });
            if (newBudget !== null) {
                const parsed = parseFloat(newBudget);
                if (!isNaN(parsed) && parsed >= 0) {
                    acc.budget = parsed;
                    localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
                    renderSettingsAccounts();
                    updateUI();
                } else {
                    alert("Inserisci un numero valido.");
                }
            }
        }

        function setInitialBalance(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;

            openNumberModal("Saldo iniziale del conto (â‚¬)", acc.initialBalance || 0, val => {
                acc.initialBalance = val;
                localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
                renderSettingsAccounts();
                updateUI();
            });

            if (val === null) return;

            const parsed = parseFloat(val);
            if (isNaN(parsed)) {
                alert("Inserisci un numero valido");
                return;
            }
            acc.initialBalance = parsed;
            localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
            renderSettingsAccounts();
            updateUI();
        }

        function deleteAccount(id) {

            if (accounts.length === 1) {
                alert("Non puoi eliminare l'ultimo conto.\nCrea prima un nuovo conto.");
                return;
            }

            const txCount = transactions.filter(t => t.accountId === id).length;

            if (txCount > 0) {

                const choice = confirm(
                    `Questo conto ha ${txCount} movimenti.\n\n` +
                    `OK = Elimina anche i movimenti\n` +
                    `ANNULLA = Sposta i movimenti su un altro conto`
                );

                if (choice) {
                    // ðŸ”´ ELIMINA MOVIMENTI
                    transactions = transactions.filter(t => t.accountId !== id);
                } else {
                    // ðŸ” SPOSTA MOVIMENTI
                    const target = prompt(
                        "Inserisci l'ID del conto di destinazione:\n" +
                        accounts.filter(a => a.id !== id).map(a => `${a.id} â†’ ${a.name}`).join('\n')
                    );

                    if (!target || !accounts.find(a => a.id === target)) {
                        alert("Operazione annullata");
                        return;
                    }

                    transactions.forEach(t => {
                        if (t.accountId === id) t.accountId = target;
                    });
                }
            }

            // ðŸ§¹ ELIMINA CONTO
            accounts = accounts.filter(a => a.id !== id);

            // ðŸ”„ riallinea sempre il conto attivo
            if (activeAccountId === id || !accounts.find(a => a.id === activeAccountId)) {
                activeAccountId = accounts[0].id;

                renderSettingsAccounts();
                updateUI();
            }

            // ðŸ’¾ SALVA
            localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
            localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));

            renderSettingsAccounts();
            updateUI();
        }

        function navigateAccount(dir) {
            const idx = accounts.findIndex(a => a.id === activeAccountId);
            let nextIdx = (idx + dir + accounts.length) % accounts.length;
            activeAccountId = accounts[nextIdx].id;
            updateUI();
        }

        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;

            // evita swipe accidentali
            if (Math.abs(swipeDistance) < 80) return;

            // verifica se le impostazioni sono aperte
            const settingsEl = document.getElementById('settings');
            if (!settingsEl || settingsEl.classList.contains('hidden')) return;

            // swipe orizzontale â†’ torna alla home
            closeSettings();
        }

        function renderSettingsAccounts() {
            const list = document.getElementById('account-list-settings');
            list.innerHTML = accounts.map(a => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl mb-2 border border-gray-100">
                                <div class="flex flex-col overflow-hidden mr-2">
                                    <span class="font-bold text-sm truncate ${a.id === activeAccountId ? 'text-indigo-600' : 'text-gray-800'}">${a.name}</span>
                                    <span class="text-[10px] text-gray-500 font-medium">Budget: â‚¬ ${(a.budget || 0).toLocaleString('it-IT')}</span>
                                    <span class="text-[10px] text-green-500 font-medium"> Saldo iniziale: â‚¬ ${(a.initialBalance || 0).toLocaleString('it-IT')}</span>
                                </div>
                                <div class="flex space-x-1 shrink-0">
                                    <button onclick="setInitialBalance('${a.id}')" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors" title="Saldo iniziale">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2 m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6 a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                    </button>
                                    <button onclick="setBudget('${a.id}')" class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition-colors" title="Imposta Budget">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                    </button>
                                    <button onclick="renameAccount('${a.id}')" class="p-2 bg-gray-100 text-gray-500 rounded-lg hover:bg-gray-200 transition-colors" title="Rinomina Conto">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                                    </button>
                                    <button onclick="deleteAccount('${a.id}')" class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition-colors" title="Elimina Conto">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>`).join('');
        }

        function toggleSettings(show) {
            const view = document.getElementById('settings-view');
            if (show) { renderSettingsAccounts(); view.classList.remove('hidden'); }
            else { view.classList.add('hidden'); }
        }

        function updateUI() {
            const m = viewDate.getMonth();
            const y = viewDate.getFullYear();
            let currentAcc = accounts.find(a => a.id === activeAccountId);

            if (!currentAcc && accounts.length) {
                activeAccountId = accounts[0].id;
                currentAcc = accounts[0];
            }


            document.getElementById('current-month-display').textContent = viewDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            document.getElementById('account-name-display').textContent = currentAcc.name;

            const filtered = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === m && d.getFullYear() === y && t.accountId === activeAccountId;
            });

            const inc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const bal = (currentAcc.initialBalance || 0) + inc - exp;

            const balEl = document.getElementById('balance');
            balEl.textContent = `â‚¬ ${bal.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            const initEl = document.getElementById('initial-balance-display');

            if ((currentAcc.initialBalance || 0) !== 0) {
                initEl.textContent =
                    `Saldo iniziale: â‚¬ ${currentAcc.initialBalance.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
                initEl.classList.remove('hidden');
            } else {
                initEl.classList.add('hidden');
            }
            balEl.className = bal >= 0 ? 'text-4xl font-bold text-white' : 'text-4xl font-bold text-red-200';

            // GESTIONE BUDGET DISPLAY
            const budgetContainer = document.getElementById('budget-container');
            const budget = currentAcc.budget || 0;

            if (budget > 0) {
                budgetContainer.classList.remove('hidden');
                document.getElementById('budget-total').textContent = 'â‚¬ ' + budget.toLocaleString('it-IT');
                document.getElementById('budget-spent').textContent = 'â‚¬ ' + exp.toLocaleString('it-IT');

                let perc = (exp / budget) * 100;
                let displayPerc = perc > 100 ? 100 : perc;

                const bar = document.getElementById('budget-bar');
                bar.style.width = displayPerc + '%';

                if (exp > budget) {
                    bar.classList.remove('bg-white');
                    bar.classList.add('bg-red-400'); // Mantieni rosso per overflow
                    document.getElementById('budget-spent').classList.add('text-red-200');
                    document.getElementById('budget-spent').classList.remove('text-white');
                } else {
                    bar.classList.add('bg-white');
                    bar.classList.add('bg-red-400'); // Mantieni rosso per overflow
                    document.getElementById('budget-spent').classList.add('text-white');
                    document.getElementById('budget-spent').classList.remove('text-red-200');
                }
            } else {
                budgetContainer.classList.add('hidden');
            }

            const listEl = document.getElementById('transaction-list');
            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 text-gray-300 italic font-bold">Nessun movimento</div>`;
            } else {
                listEl.innerHTML = filtered.sort((a, b) => b.id - a.id).map(t => {
                    const cat = [...categories.expense, ...categories.income].find(c => c.id === t.category);
                    return `
                                <div onclick="editTransaction(${t.id})" class="transaction-card flex items-center justify-between p-4 bg-gray-50 rounded-2xl border-l-4 cursor-pointer transition-all" style="border-color: ${cat?.color}">
                                    <div class="flex items-center space-x-3 truncate mr-2">
                                        <span class="text-2xl">${cat?.icon}</span>
                                        <div class="truncate">
                                            <div class="font-bold text-gray-800 truncate text-sm">${t.description || cat?.label}</div>
                                            <div class="text-[9px] text-gray-400 font-bold">${new Date(t.date).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                    <span class="font-black whitespace-nowrap text-sm ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                                        ${t.type === 'income' ? '+' : '-'} â‚¬${t.amount.toFixed(2)}
                                    </span>
                                </div>`;
                }).join('');
            }
            renderChart(filtered.filter(t => t.type === 'expense'));
        }

        // AI CAMERA LOGIC
        async function handleImage(event) {
            const file = event.target.files[0];
            if (!file || !apiKey) return;
            const loader = document.getElementById('camera-loader');
            loader.classList.remove('hidden');
            try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const b64 = reader.result.split(',')[1];
                    const result = await analyzeReceipt(b64);
                    if (result.amount) document.getElementById('amount-input').value = result.amount;
                    if (result.description) document.getElementById('desc-input').value = result.description;
                    loader.classList.add('hidden');
                };
            } catch (err) { alert(err.message); loader.classList.add('hidden'); }
        }

        async function analyzeReceipt(base64) {
            const prompt = "JSON: { 'amount': float, 'description': 'store_name' }. Only JSON.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await response.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        function triggerCamera() {
            if (!apiKey) { promptApiKey(); return; }
            document.getElementById('camera-input').click();
        }

        // GESTIONE MODAL
        function openModal(mode, tx = null) {
            currentMode = mode;
            editingTxId = tx ? tx.id : null;
            selectedCategory = tx ? tx.category : categories[mode][0].id;

            // Elementi UI
            const modal = document.getElementById('modal');
            const content = document.getElementById('modal-content');
            const title = document.getElementById('modal-title');
            const saveBtn = document.getElementById('save-btn');
            const amountInput = document.getElementById('amount-input');

            // Reset visibilitÃ 
            modal.classList.remove('hidden');
            document.getElementById('delete-btn').classList.toggle('hidden', !editingTxId);

            // Configurazione Colori in base al tipo (Entrata/Uscita)
            if (mode === 'income') {
                title.textContent = editingTxId ? 'Modifica Entrata' : 'Nuova Entrata';
                title.className = "text-lg font-heading font-semibold text-green-600 uppercase tracking-wider";
                saveBtn.className = "flex-1 py-4 rounded-2xl text-white font-heading font-semibold text-lg shadow-lg active:scale-95 transition-all bg-green-500 shadow-green-200";
                amountInput.className = "w-full text-5xl font-heading font-bold text-green-600 text-center bg-transparent border-none focus:ring-0 p-0 placeholder-gray-200";
            } else {
                title.textContent = editingTxId ? 'Modifica Uscita' : 'Nuova Uscita';
                title.className = "text-lg font-heading font-semibold text-red-500 uppercase tracking-wider";
                saveBtn.className = "flex-1 py-4 rounded-2xl text-white font-heading font-semibold text-lg shadow-lg active:scale-95 transition-all bg-brand-600 shadow-brand-200"; // Uso il Brand (Viola) per salvare le uscite, o red-500 se preferisci
                amountInput.className = "w-full text-5xl font-heading font-bold text-gray-800 text-center bg-transparent border-none focus:ring-0 p-0 placeholder-gray-200";
            }

            // Popola Select Account
            const accSelect = document.getElementById('modal-account-select');
            accSelect.innerHTML = accounts.map(a => `<option value="${a.id}" ${a.id === (tx ? tx.accountId : activeAccountId) ? 'selected' : ''}>${a.name}</option>`).join('');

            // Renderizza Griglia Categorie
            const grid = document.getElementById('category-grid');
            grid.innerHTML = categories[mode].map(c => `
                <button onclick="selectCategory('${c.id}')" id="cat-${c.id}" 
                    class="cat-btn p-3 rounded-2xl border flex flex-col items-center justify-center gap-2 transition-all duration-200 ${c.id === selectedCategory ? 'bg-gray-900 text-white border-gray-900 ring-2 ring-offset-1 ring-gray-300 transform scale-105' : 'bg-gray-50 border-gray-100 text-gray-500 hover:bg-gray-100'}">
                    <span class="text-2xl filter drop-shadow-sm">${c.icon}</span>
                    <span class="text-[10px] font-bold uppercase tracking-tight">${c.label}</span>
                </button>`).join('');

            // Setta Valori Input
            document.getElementById('amount-input').value = tx ? tx.amount : '';
            document.getElementById('desc-input').value = tx ? tx.description : '';

            // Gestione Data
            const dateInput = document.getElementById('date-input');
            if (tx && tx.date) {
                dateInput.value = tx.date.split('T')[0];
            } else {
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            // Animazione Entrata
            setTimeout(() => {
                content.classList.remove('translate-y-full');
                document.getElementById('amount-input').focus(); // Focus automatico sull'importo
            }, 10);
        }

        function editTransaction(id) { const tx = transactions.find(t => t.id === id); if (tx) openModal(tx.type, tx); }

        function selectCategory(id) {
            selectedCategory = id;
            // Resetta tutti i bottoni allo stato "non selezionato"
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.className = "cat-btn p-3 rounded-2xl border flex flex-col items-center justify-center gap-2 transition-all duration-200 bg-gray-50 border-gray-100 text-gray-500 hover:bg-gray-100";
            });
            // Applica lo stile "selezionato" al bottone cliccato
            const activeBtn = document.getElementById('cat-' + id);
            // Usa un colore diverso se Ã¨ Entrata (Verde) o Uscita (Viola scuro/Grigio scuro)
            const activeColor = currentMode === 'income' ? 'bg-green-500 border-green-500 ring-green-200' : 'bg-brand-600 border-brand-600 ring-brand-200';

            activeBtn.className = `cat-btn p-3 rounded-2xl border flex flex-col items-center justify-center gap-2 transition-all duration-200 text-white ring-2 ring-offset-1 transform scale-105 ${activeColor}`;
        }

        function saveTransaction() {
            const amt = parseFloat(document.getElementById('amount-input').value);
            if (isNaN(amt) || amt <= 0) return;
            const desc = document.getElementById('desc-input').value.trim();
            const targetAccId = document.getElementById('modal-account-select').value;

            const selectedDate = document.getElementById('date-input').value;

            const isoDate = selectedDate
                ? new Date(selectedDate + 'T12:00:00').toISOString()
                : new Date().toISOString();

            if (editingTxId) {
                const idx = transactions.findIndex(t => t.id === editingTxId);
                transactions[idx] = {
                    ...transactions[idx],
                    amount: amt,
                    description: desc,
                    category: selectedCategory,
                    accountId: targetAccId,
                    date: isoDate
                };
            } else {
                transactions.push({ id: Date.now(), amount: amt, description: desc, category: selectedCategory, type: currentMode, accountId: targetAccId, date: isoDate });
            }
            localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));
            activeAccountId = targetAccId;
            updateUI();
            closeModal();
        }

        function deleteTx(id) { if (confirm("Eliminare?")) { transactions = transactions.filter(t => t.id !== id); localStorage.setItem(STORAGE_TX, JSON.stringify(transactions)); updateUI(); closeModal(); } }
        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); updateUI(); }
        function closeModal() { document.getElementById('modal-content').classList.add('translate-y-full'); setTimeout(() => document.getElementById('modal').classList.add('hidden'), 300); }

        function promptApiKey() {
            const key = prompt("Inserisci API Key Gemini:", apiKey);
            if (key !== null) { apiKey = key; localStorage.setItem('gemini_api_key', key); }
        }

        function renderChart(exps) {
            const ctx = document.getElementById('expenseChart');
            const container = document.getElementById('chart-container');
            if (exps.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            const dataMap = {};
            exps.forEach(e => {
                const label = categories.expense.find(c => c.id === e.category)?.label || 'Altro';
                dataMap[label] = (dataMap[label] || 0) + e.amount;
            });
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: Object.keys(dataMap).map(l => categories.expense.find(c => c.label === l)?.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 }, padding: 10 } } },
                    cutout: '70%', maintainAspectRatio: false
                }
            });
        }

        function exportCSV() {
            const headers = ["Data", "Descrizione", "Importo", "Categoria", "Tipo", "Conto", "Budget Conto"];
            const rows = transactions.map(t => {
                const acc = accounts.find(a => a.id === t.accountId);
                return [
                    new Date(t.date).toLocaleDateString(),
                    t.description,
                    t.amount.toFixed(2),
                    t.category,
                    t.type,
                    acc?.name || "N/A",
                    acc?.budget || 0
                ].join(';')
            });
            const blob = new Blob(["\ufeff" + [headers.join(';'), ...rows].join('\n')], { type: 'text/csv' });
            downloadBackupManual(blob, `spese_export.csv`);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if (confirm("Ripristinare backup?")) {
                        transactions = d.transactions || [];
                        accounts = d.accounts || accounts;
                        localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));
                        localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
                        location.reload();
                    }
                } catch { showToast("File non valido"); }
            };
            r.readAsText(file);
        }

        function clearHistory() { if (confirm("Cancellare TUTTO?")) { localStorage.clear(); location.reload(); } }

        window.onload = updateUI;
        document.getElementById('modal').onclick = (e) => { if (e.target === document.getElementById('modal')) closeModal(); };

        let touchStartX = 0;
        let touchStartY = 0;
        let isHorizontalSwipe = false;

        document.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isHorizontalSwipe = false;
        }, { passive: true });

        document.addEventListener('touchmove', e => {
            const dx = e.touches[0].clientX - touchStartX;
            const dy = e.touches[0].clientY - touchStartY;

            // riconosce swipe orizzontale (ovunque)
            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 30) {
                isHorizontalSwipe = true;

                // ðŸ”’ blocca gesture di sistema SOLO nelle impostazioni
                const settingsEl = document.getElementById('settings-view');
                if (settingsEl && !settingsEl.classList.contains('hidden')) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        document.addEventListener('touchend', e => {

            // ðŸ”’ se il modal Ã¨ aperto â†’ chiudi e basta
            if (!isHorizontalSwipe) return;

            const dx = e.changedTouches[0].clientX - touchStartX;
            if (Math.abs(dx) < 80) return;

            const settingsEl = document.getElementById('settings-view');

            // ðŸ“Œ IMPOSTAZIONI â†’ TORNA HOME
            if (settingsEl && !settingsEl.classList.contains('hidden')) {
                toggleSettings(false);
                return;
            }

            // ðŸ“Œ HOME â†’ CAMBIO CONTO
            if (dx < 0) {
                navigateAccount(1);   // swipe sinistra
            } else {
                navigateAccount(-1);  // swipe destra
            }
        });

    </script>
    <!-- Modal numerico -->
    <div id="numberModal"
         class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">

        <!-- BOX (NON FLEX!) -->
        <div class="bg-white rounded-2xl p-5 w-72 shadow-xl">

            <h3 id="numberTitle"
                class="font-bold mb-3 text-center"></h3>

            <input id="numberInput"
                   type="number"
                   inputmode="decimal"
                   class="w-full text-center text-xl border rounded-lg py-2 mb-4"
                   placeholder="0">

            <div class="flex justify-between gap-3">
                <button onclick="closeNumberModal()"
                        class="flex-1 py-2 rounded-lg bg-gray-200">
                    Annulla
                </button>

                <button onclick="confirmNumberModal()"
                        class="flex-1 py-2 rounded-lg bg-indigo-600 text-white">
                    OK
                </button>
            </div>
        </div>
    </div>
</body>
</html>
