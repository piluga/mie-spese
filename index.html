<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MedicinePro</title>
    
    <!-- Meta Tags per PWA -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MedicinePro">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Manifest Inline -->
    <link rel="manifest" id="my-manifest">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .med-checkbox {
            appearance: none;
            width: 2.5rem;
            height: 2.5rem;
            border: 3px solid #cbd5e1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            flex-shrink: 0;
        }
        
        .med-checkbox:checked {
            background-color: #22c55e;
            border-color: #22c55e;
        }

        .med-checkbox:checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 1.2rem;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .time-btn.selected {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        /* Stili specifici per le categorie temporali */
        .med-card-mattina { background-color: #fff7ed; border-color: #ffedd5; }
        .med-card-pomeriggio { background-color: #fefce8; border-color: #fef9c3; }
        .med-card-sera { background-color: #f5f3ff; border-color: #ede9fe; }
        
        .med-card-taken { background-color: #f0fdf4 !important; border-color: #dcfce7 !important; }

        .xs\:inline { display: none; }
        @media (min-width: 400px) { .xs\:inline { display: inline; } }

        /* Camera Scanner UI */
        #camera-container {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 100;
            display: none;
            flex-direction: column;
        }
        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scanner-overlay {
            position: absolute;
            inset: 0;
            border: 2px solid rgba(255,255,255,0.3);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scanner-frame {
            width: 80%;
            height: 40%;
            border: 2px solid #3b82f6;
            border-radius: 1rem;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
            position: relative;
        }
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #3b82f6;
            top: 0;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            from { top: 0%; }
            to { top: 100%; }
        }
        
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-blue-600 text-white p-4 shadow-md z-20 flex justify-between items-center shrink-0 h-16">
        <div class="flex items-center gap-3">
            <button id="btn-back" class="hidden text-xl p-1 active:scale-95 transition-transform" aria-label="Indietro">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-xl font-bold tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-pills"></i> MedicinePro
            </h1>
        </div>
        
        <div class="flex gap-2">
            <button onclick="app.triggerImport()" class="text-sm bg-blue-500 hover:bg-blue-700 px-3 py-1.5 rounded-lg transition-colors border border-blue-400 shadow-sm">
                <i class="fa-solid fa-file-import"></i> <span class="hidden sm:inline ml-1">Carica</span>
            </button>
            <button onclick="app.exportData()" class="text-sm bg-blue-700 hover:bg-blue-800 px-3 py-1.5 rounded-lg transition-colors border border-blue-500 shadow-sm">
                <i class="fa-solid fa-download"></i> <span class="hidden sm:inline ml-1">Salva</span>
            </button>
        </div>
    </header>

    <input type="file" id="import-file" accept=".json" class="hidden" onchange="app.handleImport(this)">

    <!-- MAIN -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar relative p-4 max-w-lg mx-auto w-full">
        
        <!-- VISTA LISTA PROFILI -->
        <section id="view-profiles" class="fade-in space-y-4">
            <div class="bg-white p-6 rounded-2xl card-shadow text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 mb-2">I tuoi Profili</h2>
                <p class="text-slate-500 text-sm">Monitora le assunzioni quotidiane.</p>
            </div>
            <div id="profiles-list" class="space-y-3"></div>
            <button onclick="app.showModal('modal-add-profile')" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-user-plus"></i> Aggiungi Profilo
            </button>
        </section>

        <!-- VISTA DETTAGLIO PROFILO -->
        <section id="view-medications" class="hidden fade-in pb-24">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <h2 id="current-profile-name" class="text-2xl font-bold text-slate-800 truncate max-w-[180px]">Profilo</h2>
                        <button onclick="app.openEditProfileModal()" class="text-slate-400 hover:text-blue-600 p-1.5 transition-colors">
                            <i class="fa-solid fa-pencil text-sm"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-3 mt-1">
                        <p id="current-date-display" class="text-[10px] text-slate-500 uppercase font-bold tracking-wider"></p>
                        <button id="btn-uncheck-all" onclick="app.uncheckAllMeds()" class="hidden text-[10px] text-red-500 uppercase font-bold tracking-wider hover:underline">
                            Deseleziona tutto
                        </button>
                    </div>
                </div>
                <div class="flex flex-col gap-2 items-end">
                    <button onclick="app.exportProfileTxt()" class="text-blue-600 text-xs px-3 py-1.5 border border-blue-200 rounded-lg hover:bg-blue-50 flex items-center gap-1 transition-all">
                        <i class="fa-solid fa-file-lines"></i> <span class="xs:inline">Esporta TXT</span>
                    </button>
                    <button onclick="app.deleteCurrentProfile()" class="text-red-500 text-xs px-3 py-1.5 border border-red-200 rounded-lg hover:bg-red-50 flex items-center gap-1 transition-all">
                        <i class="fa-solid fa-trash"></i> <span class="xs:inline">Elimina Profilo</span>
                    </button>
                </div>
            </div>

            <div id="med-list-mattina" class="mb-6"></div>
            <div id="med-list-pomeriggio" class="mb-6"></div>
            <div id="med-list-sera" class="mb-6"></div>

            <div id="med-empty-state" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <i class="fa-solid fa-prescription-bottle-medical text-5xl mb-4 text-slate-200"></i>
                <p>Nessun farmaco aggiunto.</p>
            </div>

            <button onclick="app.showModal('modal-med')" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-30">
                <i class="fa-solid fa-plus"></i>
            </button>
        </section>
    </main>

    <!-- MODALI -->
    
    <!-- MODALE AGGIUNGI PROFILO -->
    <div id="modal-add-profile" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Nuovo Profilo</h3>
            <input type="text" id="input-profile-name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Es. Mario Rossi">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModal('modal-add-profile')" class="px-4 py-2 text-slate-500">Annulla</button>
                <button onclick="app.createProfile()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium">Crea</button>
            </div>
        </div>
    </div>

    <!-- MODALE MODIFICA NOME PROFILO -->
    <div id="modal-edit-profile" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Rinomina Profilo</h3>
            <input type="text" id="input-edit-profile-name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="app.closeModal('modal-edit-profile')" class="px-4 py-2 text-slate-500">Annulla</button>
                <button onclick="app.saveProfileName()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium">Salva</button>
            </div>
        </div>
    </div>

    <!-- MODALE FARMACO (Aggiunta/Modifica) -->
    <div id="modal-med" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="med-modal-title" class="text-xl font-bold text-slate-800">Farmaco</h3>
                <button onclick="app.startScanner()" id="btn-scan" class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-100 transition-colors flex items-center gap-2 text-xs font-bold">
                    <i class="fa-solid fa-camera"></i> SCANNER
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome</label>
                    <input type="text" id="input-med-name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Es. Paracetamolo">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Dose</label>
                    <input type="text" id="input-med-dose" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Es. 1 compressa">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Orari Assunzione</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="app.toggleTimeSelection('Mattina', this)" class="time-btn p-2 border rounded-lg text-sm transition-all" data-val="Mattina">Mattina</button>
                        <button onclick="app.toggleTimeSelection('Pomeriggio', this)" class="time-btn p-2 border rounded-lg text-sm transition-all" data-val="Pomeriggio">Pom.</button>
                        <button onclick="app.toggleTimeSelection('Sera', this)" class="time-btn p-2 border rounded-lg text-sm transition-all" data-val="Sera">Sera</button>
                    </div>
                </div>
            </div>
            <input type="hidden" id="input-med-edit-id">
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="app.closeModal('modal-med')" class="px-4 py-2 text-slate-500">Chiudi</button>
                <button onclick="app.handleMedicationSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium">Salva</button>
            </div>
        </div>
    </div>

    <!-- UI SCANNER -->
    <div id="camera-container">
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div class="scanner-overlay">
            <div class="scanner-frame">
                <div class="scanner-line"></div>
            </div>
        </div>
        <div class="absolute bottom-10 left-0 right-0 flex justify-center items-center gap-10">
            <button onclick="app.stopScanner()" class="w-12 h-12 rounded-full bg-white/20 text-white text-xl flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <button onclick="app.captureImage()" class="w-20 h-20 rounded-full border-4 border-white bg-blue-600 flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                <i class="fa-solid fa-camera text-3xl text-white"></i>
            </button>
            <div class="w-12"></div> <!-- Spacer -->
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
        <p id="loading-text" class="font-bold">Analisi in corso...</p>
    </div>

    <script>
        const apiKey = ""; // Gestito dall'ambiente

        const app = {
            data: { lastOpened: null, profiles: [] },
            currentProfileId: null,
            selectedTimes: [],
            touchStartX: 0,
            touchStartY: 0,
            stream: null,

            init() {
                this.loadData();
                this.checkDailyReset();
                this.renderProfiles();
                this.setupManifest();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('it-IT', options);
                
                document.getElementById('btn-back').addEventListener('click', () => this.goHome());

                document.addEventListener('touchstart', e => {
                    this.touchStartX = e.changedTouches[0].screenX;
                    this.touchStartY = e.changedTouches[0].screenY;
                }, {passive: true});

                document.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].screenX;
                    const touchEndY = e.changedTouches[0].screenY;
                    this.handleSwipe(touchEndX, touchEndY);
                }, {passive: true});
            },

            // --- CAMERA SCANNER LOGIC ---

            async startScanner() {
                const container = document.getElementById('camera-container');
                const video = document.getElementById('camera-feed');
                
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    video.srcObject = this.stream;
                    container.style.display = 'flex';
                } catch (err) {
                    alert("Impossibile accedere alla fotocamera. Verifica i permessi.");
                }
            },

            stopScanner() {
                const container = document.getElementById('camera-container');
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                container.style.display = 'none';
            },

            async captureImage() {
                const video = document.getElementById('camera-feed');
                const canvas = document.getElementById('camera-canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const base64Data = canvas.toDataURL('image/png').split(',')[1];
                this.stopScanner();
                await this.analyzeImage(base64Data);
            },

            async analyzeImage(base64Image) {
                this.toggleLoading(true, "Analisi farmaco...");
                
                const prompt = "Analizza questa immagine di un farmaco. Restituisci un oggetto JSON con due chiavi: 'name' (il nome del farmaco) e 'dose' (la concentrazione o il formato, es. 500mg, 1 compressa). Se non riesci a identificare nulla, restituisci stringhe vuote. Rispondi solo con il JSON.";
                
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: "image/png", data: base64Image } }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                name: { type: "STRING" },
                                dose: { type: "STRING" }
                            }
                        }
                    }
                };

                try {
                    const result = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, payload);
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    if (data.name) {
                        document.getElementById('input-med-name').value = data.name;
                        document.getElementById('input-med-dose').value = data.dose || "";
                    } else {
                        alert("Non ho riconosciuto il farmaco. Prova a inserirlo manualmente o scatta una foto pi√π chiara.");
                    }
                } catch (err) {
                    alert("Errore durante l'analisi dell'immagine. Riprova.");
                } finally {
                    this.toggleLoading(false);
                }
            },

            async fetchWithRetry(url, payload, retries = 5) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) return await response.json();
                    } catch (e) {}
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
                throw new Error("API fallita dopo diversi tentativi");
            },

            toggleLoading(show, text = "") {
                const overlay = document.getElementById('loading-overlay');
                const loadingText = document.getElementById('loading-text');
                loadingText.textContent = text;
                overlay.style.display = show ? 'flex' : 'none';
            },

            // --- EXISTING APP LOGIC ---

            handleSwipe(endX, endY) {
                if (!this.currentProfileId || document.querySelector('.modal-overlay:not(.hidden)')) return;
                const diffX = endX - this.touchStartX;
                const diffY = endY - this.touchStartY;
                if (Math.abs(diffX) < 70 || Math.abs(diffX) < Math.abs(diffY)) return;
                const currentIndex = this.data.profiles.findIndex(p => p.id === this.currentProfileId);
                if (diffX > 0) {
                    if (currentIndex > 0) this.openProfile(this.data.profiles[currentIndex - 1].id);
                    else this.goHome();
                } else {
                    if (currentIndex < this.data.profiles.length - 1) this.openProfile(this.data.profiles[currentIndex + 1].id);
                }
            },

            loadData() {
                const stored = localStorage.getItem('MedicineProData');
                if (stored) { try { this.data = JSON.parse(stored); } catch(e) { this.resetData(); } }
                else { this.resetData(); }
            },

            resetData() { this.data = { lastOpened: new Date().toDateString(), profiles: [] }; this.saveData(); },
            saveData() { localStorage.setItem('MedicineProData', JSON.stringify(this.data)); },

            exportData() {
                const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MedicinePro_Backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            },

            exportProfileTxt() {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (!profile) return;
                let content = `TERAPIA FARMACOLOGICA: ${profile.name.toUpperCase()}\n`;
                content += `Esportata il: ${new Date().toLocaleDateString('it-IT')}\n`;
                content += `--------------------------------------------------\n\n`;
                const times = ['Mattina', 'Pomeriggio', 'Sera'];
                let hasMeds = false;
                times.forEach(time => {
                    const meds = profile.meds.filter(m => m.time === time);
                    if (meds.length > 0) {
                        hasMeds = true;
                        content += `[${time.toUpperCase()}]\n`;
                        meds.forEach(m => { content += `- ${m.name}: ${m.dose}\n`; });
                        content += `\n`;
                    }
                });
                if (!hasMeds) content += `Nessun farmaco inserito in questo profilo.\n`;
                content += `--------------------------------------------------\nGenerato con MedicinePro.`;
                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Terapia_${profile.name.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            },

            triggerImport() { document.getElementById('import-file').click(); },
            handleImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json && Array.isArray(json.profiles)) {
                            if(confirm("Caricare questo backup? I dati attuali saranno sovrascritti.")) {
                                this.data = json; this.saveData(); this.goHome();
                            }
                        }
                    } catch(err) { alert("File non valido."); }
                    input.value = '';
                };
                reader.readAsText(file);
            },

            checkDailyReset() {
                const today = new Date().toDateString();
                if (this.data.lastOpened !== today) {
                    this.data.profiles.forEach(p => p.meds.forEach(m => m.taken = false));
                    this.data.lastOpened = today; this.saveData();
                }
            },

            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },

            goHome() {
                this.currentProfileId = null;
                document.getElementById('view-profiles').classList.remove('hidden');
                document.getElementById('view-medications').classList.add('hidden');
                document.getElementById('btn-back').classList.add('hidden');
                this.renderProfiles();
            },

            openProfile(id) {
                this.currentProfileId = id;
                const view = document.getElementById('view-medications');
                const list = document.getElementById('view-profiles');
                view.classList.remove('fade-in');
                void view.offsetWidth; 
                view.classList.add('fade-in');
                list.classList.add('hidden');
                view.classList.remove('hidden');
                document.getElementById('btn-back').classList.remove('hidden');
                this.renderMedications();
            },

            createProfile() {
                const name = document.getElementById('input-profile-name').value.trim();
                if (!name) return;
                this.data.profiles.push({ id: this.generateId(), name, meds: [] });
                this.saveData();
                document.getElementById('input-profile-name').value = '';
                this.closeModal('modal-add-profile');
                this.renderProfiles();
            },

            openEditProfileModal() {
                const p = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (p) {
                    document.getElementById('input-edit-profile-name').value = p.name;
                    this.showModal('modal-edit-profile');
                }
            },

            saveProfileName() {
                const newName = document.getElementById('input-edit-profile-name').value.trim();
                const p = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (p && newName) { p.name = newName; this.saveData(); this.renderMedications(); this.closeModal('modal-edit-profile'); }
            },

            deleteCurrentProfile() {
                if(confirm("Eliminare definitivamente questo profilo?")) {
                    this.data.profiles = this.data.profiles.filter(x => x.id !== this.currentProfileId);
                    this.saveData(); this.goHome();
                }
            },

            renderProfiles() {
                const container = document.getElementById('profiles-list');
                container.innerHTML = '';
                if (this.data.profiles.length === 0) {
                    container.innerHTML = `<p class="text-center text-slate-400 py-6 text-sm italic">Nessun profilo presente.</p>`;
                    return;
                }
                this.data.profiles.forEach(p => {
                    const total = p.meds.length;
                    const taken = p.meds.filter(m => m.taken).length;
                    const perc = total === 0 ? 0 : Math.round((taken/total)*100);
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-xl card-shadow flex justify-between items-center cursor-pointer border border-transparent hover:border-blue-200 transition-all";
                    div.onclick = () => this.openProfile(p.id);
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">${p.name.charAt(0).toUpperCase()}</div>
                            <div>
                                <h3 class="font-bold text-slate-800">${p.name}</h3>
                                <p class="text-xs text-slate-500">${total} farmaci</p>
                            </div>
                        </div>
                        <div class="text-right">
                             <span class="text-sm font-bold ${perc === 100 ? 'text-green-500' : 'text-blue-500'}">${perc}%</span>
                        </div>`;
                    container.appendChild(div);
                });
            },

            showModal(id) {
                if (id === 'modal-med') { 
                    const editId = document.getElementById('input-med-edit-id').value;
                    if (!editId) this.resetMedModal(); 
                }
                document.getElementById(id).classList.remove('hidden');
            },

            resetMedModal() {
                document.getElementById('med-modal-title').textContent = "Nuovo Farmaco";
                document.getElementById('input-med-name').value = '';
                document.getElementById('input-med-dose').value = '';
                document.getElementById('input-med-edit-id').value = '';
                document.getElementById('btn-scan').classList.remove('hidden');
                this.selectedTimes = [];
                this.updateTimeUI();
            },

            openEditMedModal(medId) {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                const med = profile.meds.find(m => m.id === medId);
                if (med) {
                    document.getElementById('input-med-edit-id').value = med.id;
                    document.getElementById('input-med-name').value = med.name;
                    document.getElementById('input-med-dose').value = med.dose;
                    document.getElementById('med-modal-title').textContent = "Modifica Farmaco";
                    document.getElementById('btn-scan').classList.add('hidden'); // Nascondi scanner in modifica
                    this.selectedTimes = [med.time];
                    this.updateTimeUI();
                    this.showModal('modal-med');
                }
            },

            handleMedicationSubmit() {
                const name = document.getElementById('input-med-name').value.trim();
                const dose = document.getElementById('input-med-dose').value.trim();
                const editId = document.getElementById('input-med-edit-id').value;
                if (!name || !dose || this.selectedTimes.length === 0) return alert("Compila tutti i campi.");
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (editId) {
                    const med = profile.meds.find(m => m.id === editId);
                    if (med) { med.name = name; med.dose = dose; med.time = this.selectedTimes[0]; }
                } else {
                    this.selectedTimes.forEach(t => {
                        profile.meds.push({ id: this.generateId(), name, dose, time: t, taken: false });
                    });
                }
                this.saveData(); this.closeModal('modal-med'); this.resetMedModal(); this.renderMedications();
            },

            toggleMedication(id) {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                const med = profile.meds.find(m => m.id === id);
                if (med) { med.taken = !med.taken; this.saveData(); this.renderMedications(); }
            },

            uncheckAllMeds() {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (profile && confirm("Vuoi deselezionare tutti i farmaci presi oggi?")) {
                    profile.meds.forEach(m => m.taken = false);
                    this.saveData(); this.renderMedications();
                }
            },

            deleteMedication(id) {
                if(confirm("Eliminare questa assunzione?")) {
                    const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                    profile.meds = profile.meds.filter(m => m.id !== id);
                    this.saveData(); this.renderMedications();
                }
            },

            renderMedications() {
                const profile = this.data.profiles.find(x => x.id === this.currentProfileId);
                if (!profile) return;
                document.getElementById('current-profile-name').textContent = profile.name;
                const times = ['Mattina', 'Pomeriggio', 'Sera'];
                let hasMeds = false;
                let anyTaken = false;
                times.forEach(time => {
                    const container = document.getElementById(`med-list-${time.toLowerCase()}`);
                    container.innerHTML = '';
                    const meds = profile.meds.filter(m => m.time === time);
                    if (meds.length > 0) {
                        hasMeds = true;
                        const header = document.createElement('div');
                        header.className = "text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 pl-1 flex items-center gap-2";
                        let icon = time === 'Mattina' ? 'fa-sun text-orange-400' : (time === 'Pomeriggio' ? 'fa-cloud-sun text-yellow-500' : 'fa-moon text-indigo-400');
                        header.innerHTML = `<i class="fa-solid ${icon}"></i> ${time} <span class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-[9px]">${meds.length}</span>`;
                        container.appendChild(header);
                        meds.forEach(med => {
                            if (med.taken) anyTaken = true;
                            const card = document.createElement('div');
                            const categoryClass = `med-card-${time.toLowerCase()}`;
                            const takenClass = med.taken ? 'med-card-taken' : '';
                            card.className = `p-4 rounded-xl card-shadow border mb-3 flex items-center justify-between transition-all ${categoryClass} ${takenClass}`;
                            card.innerHTML = `
                                <div class="flex items-center gap-4 flex-1 overflow-hidden">
                                    <input type="checkbox" class="med-checkbox" ${med.taken ? 'checked' : ''} onchange="app.toggleMedication('${med.id}')">
                                    <div class="overflow-hidden cursor-pointer ${med.taken ? 'opacity-40' : ''}" onclick="app.openEditMedModal('${med.id}')">
                                        <h4 class="font-bold text-slate-800 leading-tight truncate">${med.name}</h4>
                                        <p class="text-xs text-slate-500 truncate">${med.dose}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="app.openEditMedModal('${med.id}')" class="w-8 h-8 text-slate-400 hover:text-blue-500 transition-colors">
                                        <i class="fa-solid fa-pencil text-sm"></i>
                                    </button>
                                    <button onclick="app.deleteMedication('${med.id}')" class="w-8 h-8 text-slate-400 hover:text-red-500 transition-colors">
                                        <i class="fa-solid fa-trash-can text-sm"></i>
                                    </button>
                                </div>`;
                            container.appendChild(card);
                        });
                    }
                });
                document.getElementById('btn-uncheck-all').classList.toggle('hidden', !anyTaken);
                document.getElementById('med-empty-state').classList.toggle('hidden', hasMeds);
            },

            closeModal(id) { 
                document.getElementById(id).classList.add('hidden');
                if (id === 'modal-med') this.resetMedModal();
            },
            toggleTimeSelection(time, btn) {
                const editId = document.getElementById('input-med-edit-id').value;
                if (editId) this.selectedTimes = [time]; 
                else {
                    const idx = this.selectedTimes.indexOf(time);
                    idx > -1 ? this.selectedTimes.splice(idx, 1) : this.selectedTimes.push(time);
                }
                this.updateTimeUI();
            },
            updateTimeUI() {
                document.querySelectorAll('.time-btn').forEach(b => {
                    const val = b.dataset.val;
                    if (this.selectedTimes.includes(val)) b.classList.add('selected'); 
                    else b.classList.remove('selected'); 
                });
            },

            setupManifest() {
                const manifest = {
                    "name": "MedicinePro",
                    "short_name": "MedPro",
                    "start_url": ".",
                    "display": "standalone",
                    "background_color": "#f3f4f6",
                    "theme_color": "#2563eb",
                    "icons": [
                        { "src": "https://img.icons8.com/color/192/pills-bottle.png", "sizes": "192x192", "type": "image/png" },
                        { "src": "https://img.icons8.com/color/512/pills-bottle.png", "sizes": "512x512", "type": "image/png" }
                    ]
                };
                const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                document.getElementById('my-manifest').setAttribute('href', URL.createObjectURL(blob));
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
