<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Gestione Spese Pro</title>

<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/6039/6039232.png">
<meta name="theme-color" content="#4f46e5">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f3f4f6; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif }
.loader{border:2px solid #f3f3f3;border-top:2px solid #4f46e5;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite}
@keyframes spin{100%{transform:rotate(360deg)}}
.transaction-card:active{transform:scale(.98)}
</style>
</head>

<body class="antialiased text-gray-900">

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">

<header class="bg-indigo-600 text-white p-6 rounded-b-[2.5rem] shadow-xl pt-10">
<div class="flex justify-between items-center mb-4">
<button onclick="changeMonth(-1)">â€¹</button>
<h2 id="current-month-display" class="text-lg font-semibold"></h2>
<button onclick="changeMonth(1)">â€º</button>
</div>

<div class="text-center">
<div class="text-xs uppercase opacity-80">Saldo conto</div>
<div id="balance" class="text-4xl font-bold">â‚¬ 0.00</div>

<select id="account-selector"
onchange="changeAccount(this.value)"
class="mt-2 bg-indigo-500 text-white text-xs px-3 py-1 rounded-full">
</select>
</div>
</header>

<main class="p-4">

<div class="grid grid-cols-2 gap-4 -mt-10 mb-6">
<button onclick="openModal('income')" class="bg-green-500 text-white p-4 rounded-2xl font-bold">Entrata</button>
<button onclick="openModal('expense')" class="bg-red-500 text-white p-4 rounded-2xl font-bold">Uscita</button>
</div>

<div id="chart-container" class="hidden mb-6 bg-gray-50 p-4 rounded-2xl">
<canvas id="expenseChart"></canvas>
</div>

<h2 class="text-xl font-bold mb-2">Movimenti</h2>
<div id="transaction-list" class="space-y-3 pb-24"></div>

</main>
</div>

<!-- MODAL -->
<div id="modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-end">
<div id="modal-content" class="bg-white w-full max-w-md p-6 rounded-t-3xl translate-y-full transition-transform">

<h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>

<input id="amount-input" type="number" step="0.01"
placeholder="0.00"
class="w-full p-4 bg-gray-100 rounded-2xl text-3xl font-bold text-center mb-4">

<input id="desc-input" type="text"
placeholder="Descrizione"
class="w-full p-4 bg-gray-100 rounded-2xl mb-4">

<div id="category-grid" class="grid grid-cols-4 gap-2 mb-4"></div>

<button onclick="saveTransaction()"
id="save-btn"
class="w-full py-4 rounded-2xl text-white font-bold text-xl">
Salva
</button>

<div class="h-6"></div>
</div>
</div>

<script>
/* ===================== STORAGE ===================== */
const STORAGE_KEY = 'spese_v3_data';
const ACCOUNTS_KEY = 'spese_v3_accounts';

/* ===================== CONTI ===================== */
let accounts = JSON.parse(localStorage.getItem(ACCOUNTS_KEY)) || [
{ id:'contanti', name:'Contanti', icon:'ðŸ’¶' },
{ id:'banca', name:'Banca', icon:'ðŸ¦' }
];

let currentAccount = localStorage.getItem('current_account') || accounts[0].id;

/* ===================== CATEGORIE ===================== */
const categories = {
expense:[
{id:'cibo',label:'Cibo',icon:'ðŸŽ',color:'#f87171'},
{id:'casa',label:'Casa',icon:'ðŸ ',color:'#60a5fa'},
{id:'auto',label:'Auto',icon:'ðŸš—',color:'#fbbf24'},
{id:'svago',label:'Svago',icon:'ðŸŽ®',color:'#a78bfa'},
{id:'altro',label:'Altro',icon:'ðŸ“¦',color:'#9ca3af'}
],
income:[
{id:'stipendio',label:'Stipendio',icon:'ðŸ’°',color:'#10b981'},
{id:'altro_in',label:'Altro',icon:'ðŸ“ˆ',color:'#6b7280'}
]
};

/* ===================== DATI ===================== */
let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
transactions = transactions.map(t => ({
...t,
accountId: t.accountId || accounts[0].id
}));

let viewDate = new Date();
let currentMode = 'expense';
let selectedCategory = 'altro';
let editingTxId = null;
let chartInstance = null;

/* ===================== UI ===================== */
function renderAccountSelector(){
const sel = document.getElementById('account-selector');
sel.innerHTML = accounts.map(a =>
`<option value="${a.id}" ${a.id===currentAccount?'selected':''}>
${a.icon} ${a.name}
</option>`).join('');
}

function changeAccount(id){
currentAccount = id;
localStorage.setItem('current_account', id);
updateUI();
}

function updateUI(){
renderAccountSelector();

const m=viewDate.getMonth(), y=viewDate.getFullYear();
document.getElementById('current-month-display').textContent =
viewDate.toLocaleDateString('it-IT',{month:'long',year:'numeric'});

const filtered = transactions.filter(t=>{
const d=new Date(t.date);
return d.getMonth()===m && d.getFullYear()===y && t.accountId===currentAccount;
});

const inc = filtered.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
const exp = filtered.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
document.getElementById('balance').textContent =
`â‚¬ ${(inc-exp).toFixed(2)}`;

const list=document.getElementById('transaction-list');
list.innerHTML = filtered.length ? filtered.sort((a,b)=>b.id-a.id).map(t=>{
const c=[...categories.expense,...categories.income].find(x=>x.id===t.category);
return `
<div onclick="editTransaction(${t.id})"
class="transaction-card flex justify-between p-4 bg-gray-50 rounded-2xl border-l-4"
style="border-color:${c.color}">
<div>${c.icon} ${t.description||c.label}</div>
<div class="${t.type==='income'?'text-green-600':'text-red-600'}">
${t.type==='income'?'+':'-'}â‚¬${t.amount.toFixed(2)}
</div>
</div>`;
}).join('') : '<div class="text-center text-gray-400 py-10">Nessun movimento</div>';

renderChart(filtered.filter(t=>t.type==='expense'));
}

/* ===================== MODAL ===================== */
function openModal(mode,tx=null){
currentMode=mode;
editingTxId=tx?tx.id:null;
selectedCategory=tx?tx.category:categories[mode][0].id;

document.getElementById('modal').classList.remove('hidden');
setTimeout(()=>document.getElementById('modal-content').classList.remove('translate-y-full'),10);

document.getElementById('modal-title').textContent =
editingTxId?'Modifica':'Nuovo';

document.getElementById('save-btn').className =
`w-full py-4 rounded-2xl text-white font-bold text-xl ${mode==='income'?'bg-green-500':'bg-red-500'}`;

document.getElementById('amount-input').value = tx?tx.amount:'';
document.getElementById('desc-input').value = tx?tx.description:'';

document.getElementById('category-grid').innerHTML =
categories[mode].map(c=>
`<button onclick="selectCategory('${c.id}')"
class="p-2 rounded-xl ${c.id===selectedCategory?'bg-indigo-100':''}">
${c.icon}<div class="text-xs">${c.label}</div></button>`
).join('');
}

function selectCategory(id){selectedCategory=id}

function closeModal(){
document.getElementById('modal-content').classList.add('translate-y-full');
setTimeout(()=>document.getElementById('modal').classList.add('hidden'),300);
editingTxId=null;
}

/* ===================== CRUD ===================== */
function saveTransaction(){
const amt=parseFloat(amount-input.value);
if(!amt||amt<=0)return alert('Importo non valido');

if(editingTxId){
const t=transactions.find(x=>x.id===editingTxId);
Object.assign(t,{amount:amt,description:desc-input.value,category:selectedCategory});
}else{
transactions.push({
id:Date.now(),
amount:amt,
description:desc-input.value,
category:selectedCategory,
type:currentMode,
date:new Date().toISOString(),
accountId:currentAccount
});
}
localStorage.setItem(STORAGE_KEY,JSON.stringify(transactions));
updateUI(); closeModal();
}

function editTransaction(id){
const t=transactions.find(x=>x.id===id);
if(t)openModal(t.type,t);
}

function changeMonth(d){
viewDate.setMonth(viewDate.getMonth()+d);
updateUI();
}

/* ===================== CHART ===================== */
function renderChart(exps){
const c=document.getElementById('chart-container');
if(!exps.length){c.classList.add('hidden');return;}
c.classList.remove('hidden');

const map={};
exps.forEach(e=>{
const cat=categories.expense.find(c=>c.id===e.category);
map[cat.label]=(map[cat.label]||0)+e.amount;
});

if(chartInstance)chartInstance.destroy();
chartInstance=new Chart(expenseChart,{
type:'doughnut',
data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]},
options:{cutout:'70%'}
});
}

window.onload=updateUI;
</script>
</body>
</html>
