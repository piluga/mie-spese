<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>SpesePro</title>

    <!-- PWA Meta -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SpesePro">
    <link rel="apple-touch-icon" href="https://i.ibb.co/vx96Xb8Q/budget.png">

    <!-- Manifest Inline -->
    <link rel="manifest" href="./manifest.json">

    <meta name="theme-color" content="#2563eb">

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }

        .transaction-card:active {
            transform: scale(0.98);
        }

        .cat-btn {
            transition: all 0.2s;
            border: 2px solid transparent;
            opacity: 0.7;
        }

            .cat-btn.selected-income {
                border-color: #10b981; /* Verde smeraldo */
                background-color: #ecfdf5;
                opacity: 1;
                transform: scale(1.05);
            }

            .cat-btn.selected-expense {
                border-color: #f43f5e; /* Rosso pastello */
                background-color: #fff1f2;
                opacity: 1;
                transform: scale(1.05);
            }

        .toast {
            position: fixed;
            bottom: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Nascondi frecce input number */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="toast" class="toast">Messaggio</div>

    <!-- HEADER -->
    <header class="bg-blue-600 text-white p-4 shadow-md z-20 flex justify-between items-center shrink-0 h-16">
        <div class="flex items-center gap-3">
            <button id="btn-back" onclick="toggleSettings(false)" class="hidden text-xl p-1 active:scale-95 transition-transform">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1 class="text-xl font-bold tracking-wide flex items-center gap-2">
                <i class="fa-solid fa-wallet"></i> SpesePro
            </h1>
        </div>

        <div class="flex gap-2">
            <button onclick="toggleSettings(true)" class="text-xl p-2 hover:bg-blue-700 rounded-full transition-colors" title="Impostazioni">
                <i class="fa-solid fa-cog"></i>
            </button>
        </div>
    </header>

    <!-- MAIN APP CONTAINER -->
    <main id="app-container" class="flex-1 overflow-y-auto no-scrollbar relative p-4 max-w-lg mx-auto w-full">

        <!-- View Principale -->
        <section id="main-view" class="fade-in pb-24">

            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handleImage(event)">
            <div id="camera-loader" class="fixed inset-0 z-[100] modal-overlay flex flex-col items-center justify-center hidden">
                <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center">
                    <div class="loader mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
                    <span class="text-blue-600 font-bold text-sm">Analisi scontrino...</span>
                </div>
            </div>

            <!-- Dashboard Card (Swipeable) -->
            <div id="dashboard-card" class="bg-blue-50 border border-blue-100 p-6 rounded-2xl card-shadow mb-6 text-center relative overflow-hidden transition-all duration-200 ease-out">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full bg-white shadow-sm text-blue-500 hover:bg-blue-100 flex items-center justify-center transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 id="current-month-display" class="text-sm font-bold text-blue-800 uppercase tracking-wider">Mese</h2>
                    <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full bg-white shadow-sm text-blue-500 hover:bg-blue-100 flex items-center justify-center transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <p id="account-name-display" class="text-[10px] text-blue-500 font-bold uppercase mb-1 flex items-center justify-center gap-1 cursor-pointer" onclick="openAccountPicker()">
                    <span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>
                    <span>Conto</span> <i class="fa-solid fa-chevron-down ml-1"></i>
                </p>
                <div id="account-dots" class="flex justify-center gap-1.5 mb-2 hidden"></div>

                <div id="balance" class="text-4xl font-bold text-blue-900 tracking-tight">€ 0.00</div>
                <div id="initial-balance-display" class="text-[10px] mt-2 text-blue-400 font-medium hidden"></div>

                <!-- Budget Bar -->
                <div id="budget-container" class="mt-4 p-3 bg-white rounded-xl border border-blue-100 cursor-pointer active:scale-95 transition-transform" onclick="setBudget(activeAccountId)">
                    <!-- Popolato da JS -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="openModal('income')" class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl card-shadow flex flex-col items-center justify-center gap-2 active:scale-95 transition-all group">
                    <div class="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-arrow-down"></i>
                    </div>
                    <span class="font-bold text-emerald-800 text-sm">Entrata</span>
                </button>
                <button onclick="openModal('expense')" class="bg-rose-50 border border-rose-100 p-4 rounded-2xl card-shadow flex flex-col items-center justify-center gap-2 active:scale-95 transition-all group">
                    <div class="w-12 h-12 rounded-full bg-rose-100 text-rose-600 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-arrow-up"></i>
                    </div>
                    <span class="font-bold text-rose-800 text-sm">Uscita</span>
                </button>
            </div>

            <!-- Chart -->
            <div id="chart-container" class="mb-6 bg-white p-5 rounded-2xl card-shadow hidden">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 text-center">Riepilogo Uscite</h4>
                <div class="h-40">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <!-- Search -->
            <div class="relative mb-4">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="search-input" placeholder="Cerca movimento o categoria..."
                       class="w-full bg-white border border-slate-200 text-slate-700 text-sm font-medium rounded-xl py-3 pl-10 pr-4 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm transition-all"
                       oninput="updateUI()">
            </div>

            <div class="flex justify-between items-center mb-3 px-1">
                <h3 class="text-sm font-bold text-slate-500 uppercase">Lista Movimenti</h3>
            </div>

            <div id="transaction-list" class="space-y-3"></div>
        </section>

        <!-- View Impostazioni -->
        <section id="settings-view" class="hidden fade-in space-y-6">
            <div class="flex items-center gap-4 mb-2">
                <h2 class="text-2xl font-bold text-slate-800">Impostazioni</h2>
            </div>

            <!-- Conti -->
            <div class="bg-white p-5 rounded-2xl card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-building-columns text-blue-500"></i> I Tuoi Conti & Budget
                </h3>
                <div id="account-list-settings" class="space-y-2 mb-4"></div>

                <button onclick="openAddAccountModal()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-600 font-semibold py-3 rounded-xl border border-blue-200 border-dashed active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-plus"></i> Nuovo Conto
                </button>
            </div>

            <!-- Dati & Backup -->
            <div class="bg-white p-5 rounded-2xl card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-server text-emerald-500"></i> Gestione Dati
                </h3>
                <p class="text-[11px] text-slate-400 mb-4 leading-relaxed">
                    Salva una copia di sicurezza o esporta i movimenti in formato CSV per Excel.
                </p>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button onclick="saveToFileSystem()" class="col-span-2 flex items-center justify-center gap-2 p-4 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded-xl hover:bg-emerald-100 transition-colors active:scale-95 text-sm font-bold">
                        <i class="fa-solid fa-download"></i> Salva Backup
                    </button>

                    <label class="cursor-pointer flex flex-col items-center justify-center p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors group active:scale-95">
                        <i class="fa-solid fa-upload text-blue-500 text-lg mb-1 group-hover:scale-110 transition-transform"></i>
                        <span class="text-[10px] font-bold text-slate-600 uppercase">Importa</span>
                        <input type="file" id="import-json" class="hidden" accept=".json" onchange="importJSON(event)">
                    </label>

                    <button onclick="exportCSV()" class="flex flex-col items-center justify-center p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition-colors group active:scale-95">
                        <i class="fa-solid fa-file-csv text-green-500 text-lg mb-1 group-hover:scale-110 transition-transform"></i>
                        <span class="text-[10px] font-bold text-slate-600 uppercase">Esporta CSV</span>
                    </button>
                </div>
            </div>

            <!-- Scanner AI -->
            <div class="bg-sky-50 p-5 rounded-2xl card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles text-indigo-500"></i> Google Gemini API
                </h3>
                <p class="text-[11px] text-slate-500 mb-4 leading-relaxed">
                    Configura la chiave API per abilitare l'analisi automatica degli scontrini tramite fotocamera.
                </p>
                <button onclick="openApiKeyModal()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition-all text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-key"></i> Configura Chiave API
                </button>
            </div>

            <!-- Reset -->
            <div class="bg-white p-5 rounded-2xl card-shadow mt-6">
                <button onclick="openResetModal()" class="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition-all flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-triangle-exclamation"></i> Resetta tutti i dati
                </button>
            </div>
        </section>
    </main>

    <!-- ================= MODALI (Stile MedicinePro) ================= -->
    <!-- Modal Inserimento (Add/Edit) -->
    <div id="modal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-0 overflow-hidden flex flex-col max-h-[90vh]">
            <div id="modal-header" class="p-4 border-b flex justify-between items-center shrink-0 transition-colors">
                <div class="flex items-center gap-3">
                    <h3 id="modal-title" class="text-lg font-bold">Nuova Transazione</h3>
                    <button id="modal-camera-btn" onclick="triggerCamera()" class="w-10 h-10 flex items-center justify-center rounded-full active:scale-95 transition-all shadow-sm" title="Scansiona scontrino">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                </div>
                <button id="modal-close-btn" onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-5 overflow-y-auto custom-scrollbar space-y-4">
                <!-- Importo -->
                <div id="modal-amount-box" class="relative rounded-xl p-4 border text-center transition-colors">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Importo (€)</label>
                    <div class="flex items-center justify-center">
                        <input type="number" id="amount-input" step="0.01" inputmode="decimal" placeholder="0.00"
                               class="w-full text-4xl font-bold text-center bg-transparent border-none focus:ring-0 p-0 outline-none">
                    </div>
                </div>

                <!-- Data & Conto -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Data</label>
                        <input type="date" id="date-input" class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold text-slate-700 bg-white shadow-sm">
                    </div>
                    <div onclick="openAccountPicker()" class="cursor-pointer">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Conto</label>
                        <div class="w-full p-3 border border-slate-200 rounded-xl bg-white shadow-sm flex items-center justify-between hover:border-blue-300 transition-colors">
                            <span id="selected-account-display" class="font-bold text-slate-700 text-sm truncate">...</span>
                            <i class="fa-solid fa-chevron-down text-slate-300 text-[10px]"></i>
                        </div>
                        <input type="hidden" id="modal-account-select">
                    </div>
                </div>

                <!-- Descrizione -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nota / Descrizione</label>
                    <div class="relative">
                        <i class="fa-solid fa-pen absolute left-3 top-3.5 text-slate-400 text-sm"></i>
                        <input type="text" id="desc-input" placeholder="Es. Spesa al supermercato..."
                               class="w-full pl-9 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 font-medium bg-white text-sm transition-shadow">
                    </div>
                </div>

                <!-- Categorie -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Categoria</label>
                    <div id="category-grid" class="grid grid-cols-4 gap-2">
                        <!-- Generato via JS -->
                    </div>
                </div>
            </div>

            <div id="modal-footer" class="p-4 border-t flex gap-3 shrink-0 transition-colors">
                <button id="delete-btn" onclick="deleteTx(editingTxId)" class="hidden px-4 py-2.5 bg-red-50 text-red-600 rounded-xl font-bold shadow-sm hover:bg-red-100 transition-colors active:scale-95">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
                <button id="save-btn" onclick="saveTransaction()" class="flex-1 py-3 text-white rounded-xl font-bold shadow-md transition-all active:scale-95">
                    Salva Movimento
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Alert Semplice -->
    <div id="simple-alert-modal" class="hidden fixed inset-0 modal-overlay z-[200] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-circle-info"></i>
            </div>
            <h3 id="alert-title" class="text-xl font-bold text-slate-800 mb-2">Avviso</h3>
            <p id="alert-message" class="text-slate-500 mb-6 text-sm leading-relaxed"></p>
            <button onclick="closeSimpleAlert()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-transform active:scale-95">OK</button>
        </div>
    </div>

    <!-- Modale Aggiungi Conto -->
    <div id="new-account-modal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-slate-800">Nuovo Conto</h3>
                <button onclick="closeAddAccountModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Nome Conto</label>
                    <input type="text" id="modal-new-name" placeholder="Es. Hype, Conto Corrente..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold text-slate-700">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Saldo Iniziale (€)</label>
                    <input type="number" id="modal-new-balance" placeholder="0.00" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold text-slate-700">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Budget Mensile (€)</label>
                    <input type="number" id="modal-new-budget" placeholder="Opzionale" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold text-slate-700">
                </div>
            </div>
            <button onclick="confirmAddAccount()" class="w-full mt-6 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition-all">
                Crea Conto
            </button>
        </div>
    </div>

    <!-- Modale Rinomina Conto -->
    <div id="rename-modal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-pen"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-4">Rinomina Conto</h3>
            <input type="text" id="rename-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm font-bold text-slate-700 mb-6 text-center" placeholder="Nuovo nome">
            <div class="flex gap-3">
                <button onclick="closeRenameModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button onclick="confirmRename()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition-all">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modale Input Numerico (Per Budget e Saldo Iniziale) -->
    <div id="numberModal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 id="numberTitle" class="text-lg font-bold text-slate-800 mb-4">Inserisci Valore</h3>
            <input type="number" id="numberInput" inputmode="decimal" step="0.01" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-xl font-bold text-slate-700 text-center mb-6" placeholder="0.00">
            <div class="flex gap-3">
                <button onclick="closeNumberModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button onclick="confirmNumberModal()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition-all">OK</button>
            </div>
        </div>
    </div>

    <!-- Modale Elimina Conto -->
    <div id="delete-account-modal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-1">Elimina Conto</h3>
            <p class="text-slate-500 text-sm mb-4">Questa azione è irreversibile.</p>

            <div id="delete-options" class="hidden mb-6 bg-orange-50 p-4 rounded-xl border border-orange-100 text-left">
                <p class="text-[10px] font-bold text-orange-600 uppercase mb-2">Attenzione</p>
                <p class="text-xs text-orange-800 mb-3">Ci sono <span id="del-tx-count" class="font-bold">0</span> movimenti su questo conto.</p>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-200 cursor-pointer">
                        <input type="radio" name="del-strategy" value="delete" checked class="accent-red-500 w-4 h-4" onchange="toggleMoveSelect(false)">
                        <span class="text-xs font-bold text-slate-700">Elimina anche i movimenti</span>
                    </label>
                    <label class="flex items-center gap-2 p-2 bg-white rounded-lg border border-slate-200 cursor-pointer">
                        <input type="radio" name="del-strategy" value="move" class="accent-blue-500 w-4 h-4" onchange="toggleMoveSelect(true)">
                        <span class="text-xs font-bold text-slate-700">Sposta su altro conto</span>
                    </label>
                </div>
                <div id="target-acc-container" class="hidden mt-3">
                    <select id="target-acc-select" class="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm outline-none focus:border-blue-500 font-medium text-slate-700"></select>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button onclick="confirmDeleteAccount()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-md hover:bg-red-700 active:scale-95 transition-all">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Modale Elimina Transazione -->
    <div id="delete-tx-modal" class="hidden fixed inset-0 modal-overlay z-[110] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-eraser"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Elimina Movimento?</h3>
            <p class="text-slate-500 mb-6 text-sm">Il movimento verrà rimosso definitivamente.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteTxModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button onclick="confirmDeleteTx()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-md hover:bg-red-700 active:scale-95 transition-all">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Modale Scelta Conto -->
    <div id="account-picker-modal" class="hidden fixed inset-0 modal-overlay z-[110] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-building-columns text-blue-500"></i> Seleziona Conto
                </h3>
                <button onclick="closeAccountPicker()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-slate-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div id="account-picker-list" class="overflow-y-auto custom-scrollbar p-3 space-y-2 flex-1">
                <!-- Popolato via JS -->
            </div>
        </div>
    </div>

    <!-- Modale API Key -->
    <div id="api-key-modal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-key"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">API Key Gemini</h3>
            <p class="text-slate-500 mb-4 text-sm leading-relaxed">Inserisci la tua chiave di Google Gemini per scansionare gli scontrini.</p>
            <input type="text" id="modal-api-key" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none mb-6 text-sm" placeholder="Incolla chiave qui...">
            <div class="flex gap-3">
                <button onclick="closeApiKeyModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button onclick="saveApiKey()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition-all">Salva</button>
            </div>
        </div>
    </div>

    <!-- Modale Reset Dati -->
    <div id="reset-data-modal" class="hidden fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Resetta Tutto</h3>
            <p class="text-slate-500 mb-6 text-sm">Sei sicuro? Tutti i conti e movimenti verranno cancellati irreversibilmente.</p>
            <div class="flex gap-3">
                <button onclick="closeResetModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-colors">Annulla</button>
                <button onclick="confirmResetData()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-md hover:bg-red-700 active:scale-95 transition-all">Elimina Tutto</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_TX = 'spese_v3_data';
        const STORAGE_ACC = 'spese_v3_accounts';
        let apiKey = localStorage.getItem('gemini_api_key') || "";

        const categories = {
            expense: [
                { id: 'cibo', label: 'Cibo', icon: 'fa-solid fa-utensils', color: '#f87171' },
                { id: 'casa', label: 'Casa', icon: 'fa-solid fa-house', color: '#60a5fa' },
                { id: 'trasporti', label: 'Auto', icon: 'fa-solid fa-car', color: '#fbbf24' },
                { id: 'svago', label: 'Svago', icon: 'fa-solid fa-gamepad', color: '#a78bfa' },
                { id: 'salute', label: 'Salute', icon: 'fa-solid fa-heart-pulse', color: '#34d399' },
                { id: 'shopping', label: 'Shopping', icon: 'fa-solid fa-bag-shopping', color: '#f472b6' },
                { id: 'altro', label: 'Altro', icon: 'fa-solid fa-box', color: '#94a3b8' }
            ],
            income: [
                { id: 'stipendio', label: 'Stipendio', icon: 'fa-solid fa-money-bill-wave', color: '#10b981' },
                { id: 'regalo', label: 'Regalo', icon: 'fa-solid fa-gift', color: '#f59e0b' },
                { id: 'altro_in', label: 'Altro', icon: 'fa-solid fa-arrow-trend-up', color: '#6b7280' }
            ]
        };

        let transactions = JSON.parse(localStorage.getItem(STORAGE_TX)) || [];
        let rawAccounts = JSON.parse(localStorage.getItem(STORAGE_ACC)) || [{ id: 'acc_01', name: 'Conto Corrente', budget: 0 }];
        let accounts = rawAccounts.map(a => ({
            ...a,
            budget: a.budget || 0,
            initialBalance: a.initialBalance || 0
        }));

        let activeAccountId = accounts[0].id;
        let viewDate = new Date();
        let currentMode = 'expense';
        let selectedCategory = 'altro';
        let editingTxId = null;
        let chartInstance = null;
        let numberCallback = null;

        // UI TOAST
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        // --- GESTIONE MODALI DI SISTEMA ---
        function showSimpleAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('simple-alert-modal').classList.remove('hidden');
        }

        function closeSimpleAlert() {
            document.getElementById('simple-alert-modal').classList.add('hidden');
        }

        function openNumberModal(title, value, callback) {
            document.getElementById('numberTitle').innerText = title;
            const input = document.getElementById('numberInput');
            input.value = value ?? '';
            numberCallback = callback;
            document.getElementById('numberModal').classList.remove('hidden');
            setTimeout(() => input.focus(), 50);
        }

        function closeNumberModal() {
            document.getElementById('numberModal').classList.add('hidden');
            numberCallback = null;
        }

        function confirmNumberModal() {
            if (!numberCallback) return;
            const raw = document.getElementById('numberInput').value.replace(',', '.');
            const val = parseFloat(raw);
            if (isNaN(val)) {
                showSimpleAlert("Attenzione", "Inserisci un numero valido");
                return;
            }
            numberCallback(val);
            closeNumberModal();
        }

        // --- BACKUP & EXPORT ---
        function getBackupData() {
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `backup_spesepro_${timestamp}.json`;
            const data = { app: "SpesePro", version: "3.2", exportedAt: new Date().toISOString(), transactions, accounts };
            return { json: JSON.stringify(data, null, 2), filename };
        }

        async function saveToFileSystem() {
            const { json, filename } = getBackupData();
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: filename, types: [{ description: 'JSON File', accept: { 'application/json': ['.json'] } }] });
                    const writable = await handle.createWritable();
                    await writable.write(json);
                    await writable.close();
                    showToast("Salvato su disco!");
                } catch (err) {
                    if (err.name !== 'AbortError') showToast("Salvataggio annullato");
                }
            } else {
                downloadBackupManual(json, filename);
            }
        }

        function downloadBackupManual(json, filename) {
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); showToast("Backup scaricato!"); }, 100);
        }

        function exportCSV() {
            const headers = ["Data", "Descrizione", "Importo", "Categoria", "Tipo", "Conto", "Budget Conto"];
            const rows = transactions.map(t => {
                const acc = accounts.find(a => a.id === t.accountId);
                return [
                    new Date(t.date).toLocaleDateString(),
                    t.description || '',
                    t.amount.toFixed(2),
                    t.category,
                    t.type,
                    acc?.name || "N/A",
                    acc?.budget || 0
                ].join(';')
            });
            const blob = new Blob(["\ufeff" + [headers.join(';'), ...rows].join('\n')], { type: 'text/csv' });
            downloadBackupManual(blob, `spese_export.csv`);
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if (confirm("Vuoi ripristinare il backup? I dati attuali andranno persi.")) {
                        transactions = d.transactions || [];
                        accounts = d.accounts || accounts;
                        localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));
                        localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
                        location.reload();
                    }
                } catch { showToast("File non valido"); }
            };
            r.readAsText(file);
        }

        // --- CONTI ---
        function openAddAccountModal() {
            document.getElementById('modal-new-name').value = '';
            document.getElementById('modal-new-balance').value = '';
            document.getElementById('modal-new-budget').value = '';
            document.getElementById('new-account-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-new-name').focus(), 50);
        }
        function closeAddAccountModal() { document.getElementById('new-account-modal').classList.add('hidden'); }

        function confirmAddAccount() {
            const name = document.getElementById('modal-new-name').value.trim();
            const initialBalance = parseFloat(document.getElementById('modal-new-balance').value.replace(',', '.')) || 0;
            const budget = parseFloat(document.getElementById('modal-new-budget').value.replace(',', '.')) || 0;

            if (!name) { showSimpleAlert("Nome Mancante", "Per favore, inserisci un nome per il conto."); return; }

            const newAccount = { id: 'acc_' + Date.now(), name, budget, initialBalance };
            accounts.push(newAccount);
            if (accounts.length === 1) activeAccountId = newAccount.id;

            localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts));
            renderSettingsAccounts(); updateUI(); closeAddAccountModal(); showToast("Conto creato!");
        }

        let accountToRenameId = null;
        function renameAccount(id) {
            accountToRenameId = id;
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            document.getElementById('rename-input').value = acc.name;
            document.getElementById('rename-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('rename-input').focus(), 50);
        }
        function closeRenameModal() { document.getElementById('rename-modal').classList.add('hidden'); accountToRenameId = null; }
        function confirmRename() {
            if (!accountToRenameId) return;
            const newName = document.getElementById('rename-input').value.trim();
            if (newName) {
                const acc = accounts.find(a => a.id === accountToRenameId);
                if (acc) { acc.name = newName; localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts)); renderSettingsAccounts(); updateUI(); }
            }
            closeRenameModal();
        }

        let accountToDeleteId = null;
        function deleteAccount(id) {
            if (accounts.length === 1) { showSimpleAlert("Impossibile Eliminare", "Non puoi eliminare l'unico conto rimasto."); return; }
            accountToDeleteId = id;
            const txCount = transactions.filter(t => t.accountId === id).length;
            const optionsDiv = document.getElementById('delete-options');
            document.querySelector('input[name="del-strategy"][value="delete"]').checked = true;
            toggleMoveSelect(false);

            if (txCount > 0) {
                optionsDiv.classList.remove('hidden');
                document.getElementById('del-tx-count').textContent = txCount;
                document.getElementById('target-acc-select').innerHTML = accounts.filter(a => a.id !== id).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            } else { optionsDiv.classList.add('hidden'); }
            document.getElementById('delete-account-modal').classList.remove('hidden');
        }
        function toggleMoveSelect(show) { document.getElementById('target-acc-container').classList.toggle('hidden', !show); }
        function closeDeleteModal() { document.getElementById('delete-account-modal').classList.add('hidden'); accountToDeleteId = null; }

        function confirmDeleteAccount() {
            if (!accountToDeleteId) return;
            const txCount = transactions.filter(t => t.accountId === accountToDeleteId).length;
            if (txCount > 0) {
                const strategy = document.querySelector('input[name="del-strategy"]:checked').value;
                if (strategy === 'move') {
                    const targetId = document.getElementById('target-acc-select').value;
                    if (!targetId) return;
                    transactions.forEach(t => { if (t.accountId === accountToDeleteId) t.accountId = targetId; });
                } else { transactions = transactions.filter(t => t.accountId !== accountToDeleteId); }
            }
            accounts = accounts.filter(a => a.id !== accountToDeleteId);
            if (activeAccountId === accountToDeleteId) activeAccountId = accounts[0].id;
            localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts)); localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));
            renderSettingsAccounts(); updateUI(); closeDeleteModal(); showToast("Conto eliminato");
        }

        function setBudget(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            openNumberModal("Budget mensile (€)", acc.budget || 0, val => {
                acc.budget = val; localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts)); renderSettingsAccounts(); updateUI();
            });
        }

        function setInitialBalance(id) {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            openNumberModal("Saldo iniziale (€)", acc.initialBalance || 0, val => {
                acc.initialBalance = val; localStorage.setItem(STORAGE_ACC, JSON.stringify(accounts)); renderSettingsAccounts(); updateUI();
            });
        }

        // --- RENDER IMPOSTAZIONI ---
        function toggleSettings(show) {
            const main = document.getElementById('main-view');
            const settings = document.getElementById('settings-view');
            const backBtn = document.getElementById('btn-back');

            if (show) {
                renderSettingsAccounts();
                main.classList.add('hidden');
                settings.classList.remove('hidden');
                backBtn.classList.remove('hidden');
            } else {
                main.classList.remove('hidden');
                settings.classList.add('hidden');
                backBtn.classList.add('hidden');
                updateUI();
            }
        }

        function renderSettingsAccounts() {
            const list = document.getElementById('account-list-settings');
            list.innerHTML = accounts.map(a => `
                    <div class="p-3 border border-slate-100 rounded-xl bg-slate-50 flex items-center justify-between">
                        <div class="overflow-hidden mr-2">
                            <span class="font-bold text-sm truncate ${a.id === activeAccountId ? 'text-blue-600' : 'text-slate-700'}">${a.name}</span>
                            <div class="text-[10px] text-slate-500 font-medium mt-0.5">Saldo: € ${(a.initialBalance || 0).toLocaleString('it-IT')} | Budget: € ${(a.budget || 0).toLocaleString('it-IT')}</div>
                        </div>
                        <div class="flex gap-1 shrink-0">
                            <button onclick="setInitialBalance('${a.id}')" class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center hover:bg-emerald-100 transition-colors"><i class="fa-solid fa-coins"></i></button>
                            <button onclick="setBudget('${a.id}')" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition-colors"><i class="fa-solid fa-bullseye"></i></button>
                            <button onclick="renameAccount('${a.id}')" class="w-8 h-8 rounded-lg bg-slate-200 text-slate-500 flex items-center justify-center hover:bg-slate-300 transition-colors"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteAccount('${a.id}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center hover:bg-red-100 transition-colors"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`).join('');
        }

        // --- ACCOUNT PICKER ---
        function openAccountPicker() {
            const list = document.getElementById('account-picker-list');
            const currentId = document.getElementById('modal-account-select')?.value || activeAccountId;

            list.innerHTML = accounts.map(a => {
                const isSelected = a.id === currentId;
                const activeClass = isSelected ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100 hover:bg-slate-50';
                return `
                        <button onclick="pickAccount('${a.id}', '${a.name}')" class="w-full flex items-center justify-between p-4 border rounded-xl ${activeClass} transition-colors text-left">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-lg"><i class="fa-solid fa-building-columns"></i></div>
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">${a.name}</div>
                                    <div class="text-[10px] text-slate-400">Saldo Iniziale: € ${a.initialBalance}</div>
                                </div>
                            </div>
                            ${isSelected ? '<i class="fa-solid fa-check text-blue-600"></i>' : ''}
                        </button>`;
            }).join('');
            document.getElementById('account-picker-modal').classList.remove('hidden');
        }
        function closeAccountPicker() { document.getElementById('account-picker-modal').classList.add('hidden'); }
        function pickAccount(id, name) {
            const selectEl = document.getElementById('modal-account-select');
            if (selectEl) {
                selectEl.value = id;
                document.getElementById('selected-account-display').textContent = name;
            } else {
                activeAccountId = id;
                updateUI();
            }
            closeAccountPicker();
        }

        // --- TRANSACTIONS ---
        function getFriendlyDate(dateStr) {
            const d = new Date(dateStr);
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            if (dateStr === today) return 'Oggi';
            if (dateStr === yesterday) return 'Ieri';
            return d.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'long' });
        }

        function toggleGroup(dateKey) {
            const list = document.getElementById(`group-list-${dateKey}`);
            const icon = document.getElementById(`group-icon-${dateKey}`);
            list.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth() + d); updateUI(); }

        function updateUI() {
            const m = viewDate.getMonth();
            const y = viewDate.getFullYear();
            let currentAcc = accounts.find(a => a.id === activeAccountId);
            if (!currentAcc && accounts.length) { activeAccountId = accounts[0].id; currentAcc = accounts[0]; }

            document.getElementById('current-month-display').textContent = viewDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
            document.getElementById('account-name-display').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> <span>${currentAcc.name}</span> <i class="fa-solid fa-chevron-down ml-1 text-blue-400"></i>`;

            // Aggiorna pallini indicatori conti
            const dotsContainer = document.getElementById('account-dots');
            if (accounts.length > 1) {
                dotsContainer.innerHTML = accounts.map(a =>
                    `<div class="w-1.5 h-1.5 rounded-full ${a.id === activeAccountId ? 'bg-blue-500 scale-125' : 'bg-blue-200'} transition-all"></div>`
                ).join('');
                dotsContainer.classList.remove('hidden');
            } else {
                dotsContainer.classList.add('hidden');
            }

            const filtered = transactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === m && d.getFullYear() === y && t.accountId === activeAccountId;
            });

            const inc = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const bal = (currentAcc.initialBalance || 0) + inc - exp;

            const balEl = document.getElementById('balance');
            balEl.textContent = `€ ${bal.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
            balEl.className = bal >= 0 ? 'text-4xl font-bold text-blue-900 tracking-tight' : 'text-4xl font-bold text-red-500 tracking-tight';

            const initEl = document.getElementById('initial-balance-display');
            if ((currentAcc.initialBalance || 0) !== 0) {
                initEl.textContent = `Saldo iniziale: € ${currentAcc.initialBalance.toLocaleString('it-IT', { minimumFractionDigits: 2 })}`;
                initEl.classList.remove('hidden');
            } else { initEl.classList.add('hidden'); }

            // Nuova gestione visiva del Budget Fissa con animazione dinamica
            const budgetContainer = document.getElementById('budget-container');
            const budget = currentAcc.budget || 0;

            if (budget > 0) {
                let perc = Math.min((exp / budget) * 100, 100);
                const isOverBudget = exp > budget;
                const barColorClass = isOverBudget ? 'bg-red-500' : 'bg-blue-500';
                const spentColorClass = isOverBudget ? 'text-red-600' : 'text-blue-800';

                // Disegna la barra inizialmente a larghezza 0%
                budgetContainer.innerHTML = `
                        <div class="flex justify-between text-[10px] font-bold text-blue-600 uppercase mb-1.5">
                            <span>Speso: <strong id="budget-spent" class="${spentColorClass}">€${exp.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</strong></span>
                            <span>Budget: <strong id="budget-total" class="text-blue-800">€${budget.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</strong></span>
                        </div>
                        <div class="w-full bg-blue-100 rounded-full h-2 overflow-hidden">
                            <div id="budget-bar" class="${barColorClass} h-full rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    `;

                // Attiva l'animazione applicando la larghezza reale un istante dopo
                setTimeout(() => {
                    const bar = document.getElementById('budget-bar');
                    if (bar) bar.style.width = perc + '%';
                }, 50);

            } else {
                budgetContainer.innerHTML = `
                        <div class="flex items-center justify-center gap-2 text-xs font-bold text-blue-500 py-1">
                            <i class="fa-solid fa-bullseye text-blue-400"></i> Imposta un Budget Mensile
                        </div>
                    `;
            }

            const listEl = document.getElementById('transaction-list');
            const searchTerm = (document.getElementById('search-input')?.value || '').toLowerCase().trim();

            let listTransactions = filtered;
            if (searchTerm) {
                listTransactions = filtered.filter(t => {
                    const cat = [...categories.expense, ...categories.income].find(c => c.id === t.category);
                    return (t.description || '').toLowerCase().includes(searchTerm) || (cat && cat.label.toLowerCase().includes(searchTerm));
                });
            }

            if (listTransactions.length === 0) {
                listEl.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fa-solid fa-receipt text-4xl text-slate-300 mb-3"></i><p class="text-sm font-bold text-slate-500">${searchTerm ? 'Nessun risultato' : 'Nessun movimento'}</p></div>`;
            } else {
                listTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                const groups = {};
                listTransactions.forEach(t => { const d = t.date.split('T')[0]; if (!groups[d]) groups[d] = []; groups[d].push(t); });

                listEl.innerHTML = Object.keys(groups).map(dateKey => {
                    const dailyTx = groups[dateKey];
                    const dailySum = dailyTx.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
                    const sumColor = dailySum >= 0 ? 'text-emerald-500' : 'text-slate-500';

                    const txHtml = dailyTx.map(t => {
                        const cat = [...categories.expense, ...categories.income].find(c => c.id === t.category);
                        const isInc = t.type === 'income';
                        const amountStr = `${isInc ? '+' : '-'} €${t.amount.toFixed(2)}`;

                        return `
                            <div onclick="editTransaction(${t.id})" class="bg-white p-3 rounded-xl border border-slate-100 card-shadow mb-2 flex items-center justify-between cursor-pointer active:scale-98 transition-all relative overflow-hidden">
                                <div class="flex items-center gap-3 overflow-hidden z-10">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shrink-0 shadow-sm" style="background-color: ${cat?.color || '#94a3b8'}">
                                        <i class="${cat?.icon || 'fa-solid fa-box'}"></i>
                                    </div>
                                    <div class="truncate">
                                        <h4 class="font-bold text-slate-800 text-sm truncate leading-tight">${t.description || cat?.label}</h4>
                                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400">${cat?.label}</span>
                                    </div>
                                </div>
                                <span class="font-bold whitespace-nowrap text-sm z-10 ${isInc ? 'text-emerald-600' : 'text-slate-800'}">${amountStr}</span>
                            </div>`;
                    }).join('');

                    return `
                        <div class="mb-4">
                            <div onclick="toggleGroup('${dateKey}')" class="flex justify-between items-center px-2 mb-2 cursor-pointer select-none">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">${getFriendlyDate(dateKey)}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold ${sumColor}">${dailySum > 0 ? '+' : ''}€${dailySum.toFixed(2)}</span>
                                    <i id="group-icon-${dateKey}" class="fa-solid fa-chevron-down text-slate-300 text-[10px] transition-transform rotate-180"></i>
                                </div>
                            </div>
                            <div id="group-list-${dateKey}" class="space-y-0">${txHtml}</div>
                        </div>`;
                }).join('');
            }
            renderChart(filtered.filter(t => t.type === 'expense'));
        }

        function renderChart(exps) {
            const ctx = document.getElementById('expenseChart');
            const container = document.getElementById('chart-container');
            if (exps.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            const dataMap = {};
            exps.forEach(e => {
                const label = categories.expense.find(c => c.id === e.category)?.label || 'Altro';
                dataMap[label] = (dataMap[label] || 0) + e.amount;
            });
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: Object.keys(dataMap).map(l => categories.expense.find(c => c.label === l)?.color),
                        borderWidth: 0
                    }]
                },
                options: { plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10, family: 'Inter' } } } }, cutout: '75%', maintainAspectRatio: false }
            });
        }

        // --- GESTIONE SWIPE PER CAMBIO CONTO ---
        let touchStartX = 0;
        let touchEndX = 0;

        const dashCard = document.getElementById('dashboard-card');

        dashCard.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        dashCard.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            const threshold = 50; // Distanza minima in pixel per considerare lo swipe valido
            if (touchEndX < touchStartX - threshold) {
                // Swipe a sinistra: vai al conto successivo
                switchAccountBySwipe(1);
            }
            if (touchEndX > touchStartX + threshold) {
                // Swipe a destra: vai al conto precedente
                switchAccountBySwipe(-1);
            }
        }

        function switchAccountBySwipe(direction) {
            if (accounts.length <= 1) return; // Se c'è solo un conto non fare nulla

            let currentIndex = accounts.findIndex(a => a.id === activeAccountId);
            currentIndex += direction;

            // Logica circolare (loop)
            if (currentIndex >= accounts.length) currentIndex = 0;
            if (currentIndex < 0) currentIndex = accounts.length - 1;

            activeAccountId = accounts[currentIndex].id;

            // Aggiungo un piccolo feedback visivo animato alla card
            dashCard.style.transform = direction > 0 ? 'translateX(-15px)' : 'translateX(15px)';
            dashCard.style.opacity = '0.5';

            setTimeout(() => {
                updateUI();
                dashCard.style.transform = 'translateX(0)';
                dashCard.style.opacity = '1';
            }, 150);
        }

        // --- MODAL TX ---
        function openModal(mode, tx = null) {
            currentMode = mode;
            editingTxId = tx ? tx.id : null;
            selectedCategory = tx ? tx.category : categories[mode][0].id;

            document.getElementById('modal-title').textContent = editingTxId ? (mode === 'income' ? 'Modifica Entrata' : 'Modifica Uscita') : (mode === 'income' ? 'Nuova Entrata' : 'Nuova Uscita');
            document.getElementById('delete-btn').classList.toggle('hidden', !editingTxId);

            // --- APPLICAZIONE COLORI PASTELLO DINAMICI ---
            const isInc = mode === 'income';

            // Header e Footer
            document.getElementById('modal-header').className = `p-4 border-b flex justify-between items-center shrink-0 transition-colors ${isInc ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}`;
            document.getElementById('modal-title').className = `text-lg font-bold ${isInc ? 'text-emerald-900' : 'text-rose-900'}`;
            document.getElementById('modal-close-btn').className = `w-8 h-8 flex items-center justify-center rounded-full transition-colors ${isInc ? 'text-emerald-600 hover:bg-emerald-200' : 'text-rose-600 hover:bg-rose-200'}`;
            document.getElementById('modal-footer').className = `p-4 border-t flex gap-3 shrink-0 transition-colors ${isInc ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}`;

            // Box Importo
            document.getElementById('modal-amount-box').className = `relative rounded-xl p-4 border text-center transition-colors ${isInc ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}`;
            document.getElementById('amount-input').className = `w-full text-4xl font-bold text-center bg-transparent border-none focus:ring-0 p-0 outline-none ${isInc ? 'text-emerald-900' : 'text-rose-900'}`;
            document.getElementById('modal-camera-btn').className = `w-10 h-10 flex items-center justify-center rounded-full active:scale-95 transition-all shadow-sm ${isInc ? 'text-emerald-600 bg-emerald-100 hover:bg-emerald-200' : 'text-rose-600 bg-rose-100 hover:bg-rose-200'}`;

            // Pulsante Salva
            document.getElementById('save-btn').className = `flex-1 py-3 text-white rounded-xl font-bold shadow-md transition-all active:scale-95 ${isInc ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-rose-500 hover:bg-rose-600'}`;

            const targetAccId = tx ? tx.accountId : activeAccountId;
            const targetAcc = accounts.find(a => a.id === targetAccId) || accounts[0];
            document.getElementById('modal-account-select').value = targetAcc.id;
            document.getElementById('selected-account-display').textContent = targetAcc.name;

            renderCategoryGrid();

            document.getElementById('amount-input').value = tx ? tx.amount : '';
            document.getElementById('desc-input').value = tx ? tx.description : '';
            document.getElementById('date-input').value = tx && tx.date ? tx.date.split('T')[0] : new Date().toISOString().split('T')[0];

            document.getElementById('modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('amount-input').focus(), 50);
        }

        function renderCategoryGrid() {
            const grid = document.getElementById('category-grid');
            grid.innerHTML = categories[currentMode].map(c => `
                    <button onclick="selectCategory('${c.id}')" id="cat-${c.id}" class="cat-btn flex flex-col items-center justify-center p-3 border border-slate-200 rounded-xl bg-white shadow-sm outline-none">
                        <i class="${c.icon} text-2xl" style="color: ${c.color}"></i>
                        <span class="text-[10px] font-bold text-slate-600 mt-2 uppercase tracking-tight">${c.label}</span>
                    </button>`).join('');
            selectCategory(selectedCategory);
        }

        function selectCategory(id) {
            selectedCategory = id;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.remove('selected-income', 'selected-expense');
            });
            const btn = document.getElementById('cat-' + id);
            if (btn) {
                btn.classList.add(currentMode === 'income' ? 'selected-income' : 'selected-expense');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            editingTxId = null;
        }

        function saveTransaction() {
            const amt = parseFloat(document.getElementById('amount-input').value);
            if (isNaN(amt) || amt <= 0) { showSimpleAlert("Attenzione", "Inserisci un importo valido."); return; }
            const desc = document.getElementById('desc-input').value.trim();
            const targetAccId = document.getElementById('modal-account-select').value;
            const selectedDate = document.getElementById('date-input').value;
            const isoDate = selectedDate ? new Date(selectedDate + 'T12:00:00').toISOString() : new Date().toISOString();

            if (editingTxId) {
                const idx = transactions.findIndex(t => t.id === editingTxId);
                transactions[idx] = { ...transactions[idx], amount: amt, description: desc, category: selectedCategory, accountId: targetAccId, date: isoDate };
            } else {
                transactions.push({ id: Date.now(), amount: amt, description: desc, category: selectedCategory, type: currentMode, accountId: targetAccId, date: isoDate });
            }
            localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));
            activeAccountId = targetAccId;
            updateUI(); closeModal();
        }

        function editTransaction(id) { const tx = transactions.find(t => t.id === id); if (tx) openModal(tx.type, tx); }

        function deleteTx(id) {
            txToDeleteId = id;
            document.getElementById('delete-tx-modal').classList.remove('hidden');
        }
        function closeDeleteTxModal() { document.getElementById('delete-tx-modal').classList.add('hidden'); txToDeleteId = null; }
        function confirmDeleteTx() {
            if (!txToDeleteId) return;
            transactions = transactions.filter(t => t.id !== txToDeleteId);
            localStorage.setItem(STORAGE_TX, JSON.stringify(transactions));
            updateUI(); closeDeleteTxModal(); closeModal(); showToast("Movimento eliminato");
        }

        // --- GEMINI AI ---
        function openApiKeyModal() {
            document.getElementById('modal-api-key').value = apiKey;
            document.getElementById('api-key-modal').classList.remove('hidden');
        }
        function closeApiKeyModal() { document.getElementById('api-key-modal').classList.add('hidden'); }
        function saveApiKey() {
            const key = document.getElementById('modal-api-key').value.trim();
            if (key) { apiKey = key; localStorage.setItem('gemini_api_key', key); showToast("API Key salvata!"); }
            else { apiKey = ""; localStorage.removeItem('gemini_api_key'); showToast("API Key rimossa"); }
            closeApiKeyModal();
        }

        function triggerCamera() {
            if (!apiKey) { openApiKeyModal(); return; }
            document.getElementById('camera-input').click();
        }

        async function handleImage(event) {
            const file = event.target.files[0];
            if (!file || !apiKey) return;
            const loader = document.getElementById('camera-loader');
            loader.classList.remove('hidden');
            try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    try {
                        const b64 = reader.result.split(',')[1];
                        const result = await analyzeReceipt(b64);
                        if (result && result.amount) document.getElementById('amount-input').value = result.amount;
                        if (result && result.description) document.getElementById('desc-input').value = result.description;
                    } catch (apiError) { showSimpleAlert("Errore Scansione", apiError.message); }
                    finally { loader.classList.add('hidden'); document.getElementById('camera-input').value = ''; }
                };
            } catch (err) { showSimpleAlert("Errore", err.message); loader.classList.add('hidden'); }
        }

        async function analyzeReceipt(base64) {
            // Passa le categorie disponibili a Gemini
            const categoryList = categories.expense.map(c => c.id).join(', ');

            const prompt = `Analizza questo scontrino. Restituisci: 
            1. amount: il totale da pagare (numero decimale)
            2. description: il nome del negozio o una breve sintesi
            3. date: la data dello scontrino (formato YYYY-MM-DD)
            4. category: scegli la più adatta tra queste: [${categoryList}]`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }],
                    // Forza l'output JSON
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            if (!data.candidates || data.candidates.length === 0) throw new Error("Lettura fallita.");
            try { return JSON.parse(data.candidates[0].content.parts[0].text); }
            catch { throw new Error("Formato dati non riconosciuto."); }
        }

        // --- RESET DATI ---
        function openResetModal() { document.getElementById('reset-data-modal').classList.remove('hidden'); }
        function closeResetModal() { document.getElementById('reset-data-modal').classList.add('hidden'); }
        function confirmResetData() {
            localStorage.clear();
            showToast("Reset completato. Riavvio...");
            setTimeout(() => location.reload(), 1000);
        }

        window.onload = updateUI;

        // ==========================================
        // SERVICE WORKER REGISTRATION
        // ==========================================
        if ('serviceWorker' in navigator) {
            // Aspettiamo che la pagina sia caricata prima di registrare il SW
            window.addEventListener('load', () => {
                // Registriamo il file sw.js che si trova nella stessa cartella
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('✅ ServiceWorker registrato con successo! Scope:', registration.scope);
                    })
                    .catch(error => {
                        console.log('❌ Registrazione ServiceWorker fallita:', error);
                    });
            });
        }
    </script>
</body>
</html>
