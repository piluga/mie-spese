<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SpesePro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f3f4f6; }
.progress { height:8px;border-radius:999px;overflow:hidden;background:#e5e7eb }
.progress div { height:100%;transition:.3s }
.toast {
 position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);
 background:#111;color:#fff;padding:10px 20px;border-radius:999px;
 opacity:0;transition:.3s;z-index:999
}
</style>
</head>

<body>

<div id="toast" class="toast"></div>

<div class="max-w-md mx-auto min-h-screen bg-white shadow">

<header class="p-6 bg-indigo-600 text-white">
  <div id="account-name" class="text-xs uppercase"></div>
  <div id="balance" class="text-4xl font-bold">‚Ç¨ 0.00</div>

  <div class="mt-2">
    <div class="progress">
      <div id="budget-bar"></div>
    </div>
    <div id="budget-info" class="text-xs mt-1"></div>
  </div>
</header>

<main class="p-4">

<div class="grid grid-cols-2 gap-4 mb-4">
<button onclick="openModal('income')" class="bg-green-500 text-white p-4 rounded-xl font-bold">Entrata</button>
<button onclick="openModal('expense')" class="bg-red-500 text-white p-4 rounded-xl font-bold">Uscita</button>
</div>

<div id="chartBox" class="hidden mb-4">
<canvas id="chart"></canvas>
</div>

<div id="list" class="space-y-2"></div>

<div class="flex justify-between mt-6 text-xs font-bold">
<button onclick="openSettings()" class="text-indigo-600">‚öôÔ∏è Conti</button>
<button onclick="exportCSV()" class="text-green-600">üì§ Export CSV</button>
</div>

</main>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/60 hidden items-end">
<div class="bg-white w-full p-6 rounded-t-3xl">
<h2 id="modal-title" class="text-xl font-bold mb-4"></h2>

<select id="modal-account" class="w-full mb-3 p-2 bg-gray-100 rounded"></select>

<label class="text-xs font-bold">Data</label>
<input type="date" id="date-input" class="w-full mb-3 p-2 bg-gray-100 rounded">

<input id="amount" type="number" placeholder="Importo" class="w-full mb-3 p-3 bg-gray-100 rounded text-xl font-bold">
<input id="desc" placeholder="Descrizione" class="w-full mb-4 p-3 bg-gray-100 rounded">

<button id="saveBtn" onclick="saveTx()" class="w-full py-3 rounded-xl text-white font-bold">Salva</button>
<button onclick="closeModal()" class="mt-3 w-full text-xs text-gray-500">Annulla</button>
</div>
</div>

<!-- SETTINGS -->
<div id="settings" class="fixed inset-0 bg-white hidden p-6 overflow-y-auto">
<h2 class="text-lg font-bold mb-4">Conti & Budget</h2>
<div id="accounts-settings" class="space-y-4"></div>
<button onclick="closeSettings()" class="mt-6 text-xs text-indigo-600">‚¨Ö Torna</button>
</div>

<script>
const TX_KEY='spese_tx';
const ACC_KEY='spese_acc';
const BUD_KEY='spese_budget';

let accounts=JSON.parse(localStorage.getItem(ACC_KEY))||[
 {id:'acc1',name:'Conto Principale',budget:0}
];
let budgets=JSON.parse(localStorage.getItem(BUD_KEY))||{};
let transactions=JSON.parse(localStorage.getItem(TX_KEY))||[];
let activeAccount=accounts[0].id;
let mode='expense',chart;

/* UTIL */
function toast(m){
 let t=document.getElementById('toast');
 t.textContent=m;t.style.opacity=1;
 setTimeout(()=>t.style.opacity=0,2500);
}

/* MODAL */
function openModal(m){
 mode=m;
 modal.classList.remove('hidden');
 modalTitle.textContent=m==='income'?'Entrata':'Uscita';
 saveBtn.className='w-full py-3 rounded-xl text-white font-bold '+
  (m==='income'?'bg-green-500':'bg-red-500');
 dateInput.value=new Date().toISOString().split('T')[0];
 modalAccount.innerHTML=accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
}
function closeModal(){modal.classList.add('hidden');}

/* SAVE */
function saveTx(){
 let amt=parseFloat(amount.value);
 if(!amt||amt<=0)return;
 let iso=new Date(dateInput.value+'T12:00:00').toISOString();
 transactions.push({
  id:Date.now(),type:mode,amount:amt,
  description:desc.value,accountId:modalAccount.value,date:iso
 });
 localStorage.setItem(TX_KEY,JSON.stringify(transactions));
 closeModal();refresh();
}

/* SETTINGS */
function openSettings(){
 settings.classList.remove('hidden');
 let y=new Date().getFullYear(),m=new Date().getMonth()+1;
 accountsSettings.innerHTML=accounts.map(a=>`
 <div class="p-4 bg-gray-50 rounded-xl">
 <b>${a.name}</b>
 <label class="block text-xs mt-2">Budget base (‚Ç¨)</label>
 <input type="number" value="${a.budget||''}" class="w-full p-2"
 onchange="setBaseBudget('${a.id}',this.value)">
 <label class="block text-xs mt-2">Budget ${m}/${y}</label>
 <input type="number" value="${getMonthBudget(a.id,y,m)||''}" class="w-full p-2"
 onchange="setMonthBudget('${a.id}',${y},${m},this.value)">
 </div>`).join('');
}
function closeSettings(){settings.classList.add('hidden');}

function setBaseBudget(id,v){
 let a=accounts.find(x=>x.id===id);
 a.budget=parseFloat(v)||0;
 localStorage.setItem(ACC_KEY,JSON.stringify(accounts));
 refresh();
}
function setMonthBudget(id,y,m,v){
 budgets[`${id}_${y}_${m}`]=parseFloat(v)||0;
 localStorage.setItem(BUD_KEY,JSON.stringify(budgets));
 refresh();
}
function getMonthBudget(id,y,m){
 return budgets[`${id}_${y}_${m}`]||accounts.find(a=>a.id===id).budget||0;
}

/* EXPORT */
function exportCSV(){
 let rows=[['Data','Conto','Tipo','Importo','Descrizione']];
 transactions.forEach(t=>{
  rows.push([
   new Date(t.date).toLocaleDateString('it-IT'),
   accounts.find(a=>a.id===t.accountId).name,
   t.type,t.amount,t.description
  ]);
 });
 let csv=rows.map(r=>r.join(';')).join('\n');
 let a=document.createElement('a');
 a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
 a.download='SpesePro.csv';a.click();
}

/* RENDER */
function refresh(){
 let now=new Date(),y=now.getFullYear(),m=now.getMonth()+1;
 let acc=accounts.find(a=>a.id===activeAccount);
 accountName.textContent=acc.name;

 let tx=transactions.filter(t=>{
  let d=new Date(t.date);
  return d.getMonth()+1===m && d.getFullYear()===y && t.accountId===acc.id;
 });

 let inc=tx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
 let exp=tx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
 let bal=inc-exp;
 balance.textContent='‚Ç¨ '+bal.toFixed(2);

 let bud=getMonthBudget(acc.id,y,m);
 let perc=bud?Math.min(100,(exp/bud)*100):0;

 budgetInfo.textContent=bud?`Speso ‚Ç¨${exp.toFixed(2)} / ‚Ç¨${bud}`:'Nessun budget';
 let bar=budgetBar;
 bar.style.width=perc+'%';
 bar.style.background=perc<70?'#22c55e':perc<100?'#eab308':'#ef4444';

 balance.className='text-4xl font-bold '+(perc>100?'text-red-200':'');
 list.innerHTML=tx.map(t=>`
 <div class="p-3 bg-gray-100 rounded flex justify-between">
 <span>${t.description||'-'}</span>
 <b class="${t.type==='income'?'text-green-600':'text-red-600'}">
 ${t.type==='income'?'+':'-'}‚Ç¨${t.amount.toFixed(2)}
 </b></div>`).join('');

 renderChart(tx.filter(t=>t.type==='expense'));
}

/* CHART */
function renderChart(exps){
 if(!exps.length){chartBox.classList.add('hidden');return;}
 chartBox.classList.remove('hidden');
 if(chart)chart.destroy();
 chart=new Chart(document.getElementById('chart'),{
  type:'doughnut',
  data:{labels:['Spese'],datasets:[{data:[exps.reduce((s,t)=>s+t.amount,0)],backgroundColor:['#ef4444']}]},
  options:{cutout:'70%'}
 });
}

refresh();
</script>
</body>
</html>
